<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="es">
  <meta name="language" content="es">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de pronunciaci√≥n</title>
  <style>
    /* ===== Estilos (completos y adaptativos) ===== */
    *, *:before, *:after { box-sizing: border-box; }
    body{margin:0;padding:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .container{width:92%;max-width:980px;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:28px;margin:20px;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    .title{font-size:24px;font-weight:700;color:#2d3748}
    .instructions{font-size:14px;color:#718096}
    .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width .3s ease;width:0%}
    .question-card{background:#f7fafc;border-radius:16px;padding:20px;margin-bottom:18px}
    .question-title{font-size:18px;font-weight:600;color:#2d3748;margin-bottom:12px}
    .audio-player{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:16px;padding:14px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);width:100%}
    .audio-controls{display:flex;align-items:center;gap:12px}
    .play-button{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .play-button:disabled{opacity:.5;cursor:not-allowed}
    .options-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .option-button{padding:12px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:500;color:#2d3748;cursor:pointer;text-align:left;white-space:pre-wrap;transition:transform .12s}
    .option-button:hover:not(:disabled){transform:translateY(-3px)}
    .option-button.correct{background:#48bb78;border-color:#48bb78;color:#fff}
    .option-button.incorrect{background:#f56565;border-color:#f56565;color:#fff}
    .feedback{ text-align:center;padding:12px;border-radius:10px;margin-bottom:12px;font-size:16px;font-weight:600}
    .feedback.success{background:#c6f6d5;color:#22543d}
    .feedback.error{background:#fed7d7;color:#742a2a}
    .next-button{padding:12px 18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:12px;color:#fff;font-size:15px;cursor:pointer}
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:13px}
    .small-muted{font-size:12px;color:#94a3b8;text-align:center;margin-top:6px}
    .hidden{display:none!important}

    .panda-center { display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; width:100%; text-align:center; margin:8px 0 4px;}
    .panda-center .panda-emoji { font-size:140px; line-height:1; transform-origin:center center; animation: pandaPop .9s cubic-bezier(.2,.9,.2,1); user-select:none; }
    .panda-center .panda-text { font-size:22px; font-weight:800; color:#2d3748; letter-spacing:0.6px; }
    @keyframes pandaPop {0% { transform: scale(.4) translateY(40px); opacity:0 } 50% { transform: scale(1.08) translateY(-6px); opacity:1 } 80% { transform: scale(.96) translateY(2px) } 100% { transform: scale(1) translateY(0) }}
    .confetti { position: absolute; width: 10px; height: 10px; border-radius:2px; z-index:99; animation:confettiFall linear forwards; pointer-events:none; }
    @keyframes confettiFall { 0%{ transform: translateY(-30px) rotate(0); opacity:1 } 100%{ transform: translateY(160px) rotate(360deg); opacity:0 } }

    #adminPanel { margin-top:14px; padding:12px; border-radius:12px; background:#f8fafc; display:none; max-height:60vh; overflow:auto; border:1px solid #e6edf8; }
    .session-card { background:linear-gradient(180deg,#ffffff,#f8fafc); padding:12px; border-radius:12px; margin-bottom:10px; box-shadow:0 8px 24px rgba(11,22,48,0.03); display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .session-left { display:flex; flex-direction:column; gap:6px; max-width:70%; }
    .session-right { text-align:right; min-width:160px; }
    .session-meta { font-size:13px; color:#475569; }
    .session-stats { font-size:18px; font-weight:800; color:#334155; margin-top:6px; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:200; }
    .password-card { background: white; padding: 18px; border-radius: 12px; width: 92%; max-width: 480px; text-align: left; box-shadow: 0 12px 40px rgba(0,0,0,0.4); position:relative; }
    .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
    label { font-size:13px; color:#475569; }
    .password-input, .text-input, .select-input { width:100%; max-width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; }
    .password-actions { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .password-btn { width:100%; padding:12px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .password-error { color:#f56565; margin-top:8px; display:none; text-align:center; }
    .admin-icon { position:absolute; right:12px; top:12px; width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#f1f5f9; border:1px solid #e2e8f0; font-size:18px; color:#475569; }
    .admin-access-panel { position:absolute; right:12px; top:56px; width:260px; background:#fff; border-radius:8px; padding:10px; box-shadow:0 12px 40px rgba(0,0,0,.2); display:none; z-index:220; }

    @media (max-width:820px){ .session-left { max-width:60%; } .session-right { min-width:120px; } }
    @media (max-width:520px){ .password-card{ padding:14px; } .container{ padding:18px; } .panda-center .panda-emoji { font-size:110px; } .panda-center .panda-text { font-size:18px; } .session-card { flex-direction:column; align-items:flex-start; } .session-right { text-align:left; min-width:auto; margin-top:8px; } }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" aria-live="polite">
    <div class="header">
      <div>
        <div class="title" id="gameTitle">Juego de pronunciaci√≥n</div>
        <div class="instructions" id="instructionsText">Escucha el audio y selecciona la respuesta correcta</div>
      </div>

      <div id="adminControls" style="visibility:hidden; display:flex; gap:8px; align-items:center;">
        <button class="small-btn" id="exportAudiosBtn">Estado audios</button>
        <button class="small-btn" id="downloadResultsBtn">Info resultados</button>
        <button class="small-btn" id="downloadCsvBtn">Exportar CSV</button>
        <button class="small-btn" id="showAdminResultsBtn">Ver resultados</button>
        <button class="small-btn" id="openGameBtn">Abrir juego</button>
      </div>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

    <div id="gameContent"></div>

    <div class="small-muted" style="margin-top:12px">Tus resultados se mandar√°n autom√°ticamente a la profesora para su evaluaci√≥n</div>

    <div id="adminPanel" aria-live="polite"></div>
  </div>

  <!-- Modal contrase√±a + formulario de usuario -->
  <div id="passwordOverlay" class="overlay" style="display:none;">
    <div class="password-card" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <div class="admin-icon" id="adminIcon" title="Acceso administrador">üîí</div>
      <h2 id="pwTitle" style="text-align:center;margin:6px 0 12px">Introduce la contrase√±a</h2>

      <div class="form-row">
        <label for="userName">Nombre usuario (m√°x. 30 caracteres)</label>
        <input id="userName" class="text-input" type="text" placeholder="Ej. Mar√≠a P√©rez" aria-label="Nombre usuario" maxlength="30">
      </div>

      <div class="form-row">
        <label for="userGroup">Grupo</label>
        <select id="userGroup" class="select-input" aria-label="Grupo">
          <option value="">-- Selecciona grupo --</option>
          <option value="PANDARIN1">PANDARIN1</option>
          <option value="PANDARIN2">PANDARIN2</option>
          <option value="PANDARIN3">PANDARIN3</option>
        </select>
      </div>

      <div class="form-row">
        <label for="passwordInput">Contrase√±a</label>
        <input id="passwordInput" class="password-input" type="password" placeholder="Introduce la contrase√±a" aria-label="Contrase√±a">
      </div>

      <div class="password-actions">
        <label style="display:flex;align-items:center;gap:8px"><input id="showPassword" type="checkbox" aria-label="Mostrar contrase√±a"> Mostrar contrase√±a</label>
        <div style="flex:1"></div>
      </div>

      <button id="passwordBtn" class="password-btn">Empezar</button>
      <div id="passwordError" class="password-error">Contrase√±a incorrecta o campos incompletos</div>

      <div class="admin-access-panel" id="adminAccessPanel">
        <div style="font-weight:700;margin-bottom:8px">Acceso administrador</div>
        <input id="adminPasswordInput" class="password-input" type="password" placeholder="Contrase√±a admin" aria-label="Admin password" style="margin-bottom:8px">
        <div style="display:flex;gap:8px;">
          <button id="adminAccessBtn" class="small-btn" style="flex:1">Acceder</button>
          <button id="adminCloseBtn" class="small-btn" style="flex:1">Cerrar</button>
        </div>
        <div id="adminAccessError" style="color:#f56565;margin-top:8px;display:none;">Contrase√±a incorrecta</div>
      </div>

    </div>
  </div>

  <div id="pandaCelebration" style="position:relative"></div>

  <script>
  (function(){
    'use strict';
    console.log('Juego script inicializado (vfinal)');

    /* ========== CONFIG ======== */
    const STUDENT_PASSWORD = "PANDARIN25".normalize('NFC'); // SIN ACENTO
    const ADMIN_PASSWORD   = "XUXITO25".normalize('NFC');
    const GAME_AUDIO_MANIFEST_URL = "audio_manifest.json"; // debe existir en el repo

    /* ========== PREGUNTAS ========== */
    const questions = [
      { id: "q1_yi", title: "1. Escucha solo los 'yi' y escoge en qu√© orden aparecen", shortTitle: "Yi",
        options: ["Y√¨ y√¨ y√¨ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Y√≠ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Yƒ´ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨"], correctIndex:2 },
      { id: "q2_yi_jq", title: "2. Escucha Yi+jq y escoge el orden correcto", shortTitle: "Yi + jq",
        options: ["yƒ´j√≠ yƒ´q«ê yƒ´qƒ´ y√≠j√≠","y√≠jƒ´ yƒ´q√≠ yƒ´jƒ´ yƒ´q«ê","yƒ´q«ê yƒ´qƒ´ yƒ´j√≠ y«êj√≠"], correctIndex:0 },
      { id: "q3_jqx", title: "3. Reconoce las palabras con j-q-x y su orden de aparici√≥n", shortTitle: "J-Q-X",
        options: ["xq q x x q x x j x j x j j jj q j","xq x q q q x x j x j x j j jj j j","xq x q q q j j j x j x j j jj x x","xq x q q q x x j x j x j j jj j q"], correctIndex:3 }
    ];

    /* ========== STATE ========= */
    let gameSession = Date.now().toString();
    let currentQuestionIndex = 0;
    let questionAttempts = {};
    let correctAnswers = 0;
    let firstTryCorrectCount = 0;
    let firstTryCorrectByQuestion = {};
    let answered = false;
    let selectedAnswer = null;
    let shuffledOptions = [];
    let correctAnswerIndex = 0;
    let audioFiles = {};     // keyed by question index: audioFiles[0], audioFiles[1], audioFiles[2]
    let audioFileNames = {}; // same keys -> filename/url
    let isAdminMode = false;
    const RESULTS_KEY = 'juego_results';

    /* ========== Utilidades ========= */
    function audioKeyData(idx){ return `juego_audio_data_q${idx}`; }
    function audioKeyName(idx){ return `juego_audio_name_q${idx}`; }
    function normalizeInput(s){ if(!s) return ''; return s.replace(/[\u200B-\u200D\uFEFF]/g,'').trim().normalize('NFC'); }
    function shuffleArray(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }

    function shuffleOptions(question) {
      const opts = [...question.options];
      const correct = opts[question.correctIndex];
      shuffleArray(opts);
      correctAnswerIndex = opts.indexOf(correct);
      shuffledOptions = opts;
      return { options: shuffledOptions, correctIndex: correctAnswerIndex };
    }

    /* ========== Persistencia audios ========== */
    function saveAudioToLocal(questionIndex, dataUrl, filename){
      try {
        localStorage.setItem(audioKeyData(questionIndex), dataUrl);
        localStorage.setItem(audioKeyName(questionIndex), filename);
        const audioEl = document.createElement('audio');
        audioEl.src = dataUrl;
        audioEl.preload = 'auto';
        audioFiles[questionIndex] = audioEl;
        audioFileNames[questionIndex] = filename;
        return true;
      } catch (e) {
        console.warn('No se pudo guardar audio en localStorage:', e);
        return false;
      }
    }

    function loadSavedAudios(){
      for (let i = 0; i < questions.length; i++){
        const data = localStorage.getItem(audioKeyData(i));
        const name = localStorage.getItem(audioKeyName(i));
        if (data && name){
          try {
            const audioEl = document.createElement('audio');
            audioEl.src = data;
            audioEl.preload = 'auto';
            audioFiles[i] = audioEl;
            audioFileNames[i] = name;
          } catch(err){
            console.warn('Error al crear audio desde localStorage', err);
          }
        }
      }
    }

    /* ========== Manifest prefetch helpers adaptados a GitHub Pages ======== */
    // Esperamos un manifest en formato: [{ "name":"T1_Yi","url":"https://.../Audio_T1_Yi.m4a" }, ...]
    const EXPECTED_ORDER = ["T1_Yi","Yi_jq","T1_J_Q_X"]; // el orden que pediste: 1,2,3 -> q0,q1,q2
    async function fetchAsDataURL(url){
      try {
        const r = await fetch(url, { mode: 'cors' });
        if (!r.ok) throw new Error('fetch failed ' + r.status);
        const blob = await r.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = (e) => rej(e);
          reader.readAsDataURL(blob);
        });
      } catch (e) { console.warn('fetchAsDataURL error', e); return null; }
    }
    async function loadAudioManifestAndPrefetch(){
      if (!GAME_AUDIO_MANIFEST_URL) return;
      try {
        const res = await fetch(GAME_AUDIO_MANIFEST_URL, { cache: 'no-cache' });
        if (!res.ok) { console.warn('No se pudo cargar manifest', res.status); return; }
        const manifest = await res.json(); // array
        // map manifest entries by name for easy lookup
        const byName = {};
        for (const entry of manifest) {
          if (entry && entry.name) byName[entry.name] = entry;
        }
        // Assign to question indices according to EXPECTED_ORDER
        for (let i = 0; i < EXPECTED_ORDER.length && i < questions.length; i++){
          const key = EXPECTED_ORDER[i];
          const entry = byName[key];
          if (!entry || !entry.url) {
            console.warn('Manifest no contiene entry para', key);
            continue;
          }
          // Prefer localStorage saved data if exists (older saves)
          const localData = localStorage.getItem(audioKeyData(i));
          const localName = localStorage.getItem(audioKeyName(i));
          if (localData && localName) {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = localData;
              audioEl.preload = 'auto';
              audioFiles[i] = audioEl;
              audioFileNames[i] = localName;
              continue;
            } catch (e) { console.warn(e); }
          }

          // Intentamos prefetch a dataURL (puede fallar por CORS). Si falla, enlazamos directamente a la URL del manifest.
          const dataUrl = await fetchAsDataURL(entry.url);
          if (dataUrl) {
            const saved = saveAudioToLocal(i, dataUrl, entry.name || entry.url.split('/').pop());
            if (!saved) {
              try {
                const audioEl = document.createElement('audio');
                audioEl.src = entry.url;
                audioEl.preload = 'auto';
                audioFiles[i] = audioEl;
                audioFileNames[i] = entry.name || entry.url.split('/').pop();
              } catch(e){}
            }
          } else {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = entry.url;
              audioEl.preload = 'auto';
              audioFiles[i] = audioEl;
              audioFileNames[i] = entry.name || entry.url.split('/').pop();
            } catch(e){}
          }
        }
      } catch (err) { console.error('Error cargando manifest', err); }
    }

    /* ========== Result storage ========== */
    function getStoredResults(){ try { const raw = localStorage.getItem(RESULTS_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
    function storeResultLocal(record){ try { const arr = getStoredResults(); arr.push(record); localStorage.setItem(RESULTS_KEY, JSON.stringify(arr)); } catch(e){ console.warn(e); } }
    async function recordResult(record){
      const user_name = localStorage.getItem('juego_user_name') || '';
      const user_group = localStorage.getItem('juego_user_group') || '';
      const question = questions.find(q=>q.id===record.question_id);
      const rec = Object.assign({}, record, { user_name, user_group, question_title: question ? question.shortTitle : record.question_id });
      try { await window.dataSdk?.create?.(rec).catch(()=>{}); } catch(e){}
      storeResultLocal(rec);
    }

    /* ========== Render & l√≥gica principal ========= */
    function renderQuestion(reshuffleOptions = true) {
      const content = document.getElementById('gameContent');
      const question = questions[currentQuestionIndex];
      if (!questionAttempts[question.id]) questionAttempts[question.id] = 0;
      if (reshuffleOptions || shuffledOptions.length === 0) shuffleOptions(question);

      const progress = ((currentQuestionIndex) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';

      const hasAudio = !!audioFiles[currentQuestionIndex];
      const audioFileName = audioFileNames[currentQuestionIndex] || '';

      let audioUploadSection = '';
      if (isAdminMode) {
        audioUploadSection = `
          <div class="audio-upload-section" style="width:100%;display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:8px">
            <div style="width:100%;display:flex;gap:8px;align-items:center;justify-content:center">
              <input type="file" id="audioFile${currentQuestionIndex}" accept="audio/*" style="display:none">
              <label for="audioFile${currentQuestionIndex}" class="small-btn" style="cursor:pointer">Subir audio (Profesor)</label>
              <div style="font-size:13px;color:#4a5568">${audioFileName ? '‚úÖ ' + audioFileName : 'Sin audio'}</div>
            </div>
            <div style="font-size:12px;color:#94a3b8">Los audios subidos quedan guardados localmente para todos los alumnos que usen este navegador.</div>
          </div>
        `;
      } else {
        audioUploadSection = `<div style="width:100%;text-align:center;font-size:13px;color:${hasAudio ? '#48bb78' : '#94a3b8'}">${hasAudio ? '‚úÖ Audio disponible' : 'Audio no disponible. Pide al profesor que lo cargue.'}${audioFileName ? ' ‚Äî ' + audioFileName : ''}</div>`;
      }

      content.innerHTML = `
        <div class="question-card" role="region" aria-label="Pregunta ${currentQuestionIndex + 1}">
          <div class="question-title">${question.title}</div>
          <div class="audio-player">
            ${audioUploadSection}
            <div class="audio-controls" style="margin-top:6px;">
              <button class="play-button" id="playButton" ${hasAudio ? '' : 'disabled'} aria-label="Reproducir audio">‚ñ∂</button>
              <div id="audioStatus" style="font-size:14px;color:#718096;margin-left:6px">${audioFileName ? audioFileName : ''}</div>
            </div>
          </div>

          <div class="options-grid" id="optionsGrid">
            ${shuffledOptions.map((option, index) => `
              <button class="option-button" id="option${index}">
                ${option}
              </button>
            `).join('')}
          </div>

          <div id="feedback" aria-live="polite"></div>
          <div id="pandaCelebration" style="position:relative; min-height:140px;"></div>
          <div class="attempts-indicator" id="attemptsIndicator" style="text-align:center;font-size:13px;color:#718096;margin-top:8px">Intentos en esta pregunta: ${questionAttempts[question.id]}</div>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button class="next-button" id="nextButton" style="display: none;">
              ${currentQuestionIndex < questions.length - 1 ? 'Siguiente Pregunta' : 'Ver Resultados'}
            </button>
          </div>
        </div>
      `;
      answered = false;
      selectedAnswer = null;

      // attach events to options and play button
      document.querySelectorAll('.option-button').forEach((b,i)=> {
        b.disabled = false;
        b.addEventListener('click', (ev)=> { ev.preventDefault(); selectAnswer(i); });
      });

      const playBtn = document.getElementById('playButton');
      if (playBtn) {
        playBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          playAudio();
        });
      }

      const fileInput = document.getElementById(`audioFile${currentQuestionIndex}`);
      if (fileInput) {
        fileInput.addEventListener('change', ()=> handleAudioUpload(currentQuestionIndex));
      }

      const nextBtn = document.getElementById('nextButton');
      if (nextBtn) {
        nextBtn.onclick = () => nextQuestion();
        nextBtn.style.display = answered ? 'inline-block' : 'none';
      }

      setTimeout(()=> { const f=document.querySelector('.option-button'); if(f) f.focus(); }, 20);
    }

    function handleAudioUpload(questionIndex) {
      const fileInput = document.getElementById(`audioFile${questionIndex}`);
      if (!fileInput) return;
      if (fileInput.files && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const audioElement = document.createElement('audio');
        const url = URL.createObjectURL(file);
        audioElement.src = url;
        audioElement.preload = 'auto';
        audioFiles[questionIndex] = audioElement;
        audioFileNames[questionIndex] = file.name;
        const reader = new FileReader();
        reader.onload = function(e){
          const dataUrl = e.target.result;
          saveAudioToLocal(questionIndex, dataUrl, file.name);
          renderQuestion(false);
          alert('Audio guardado correctamente. Los alumnos podr√°n reproducirlo sin descargar.');
        };
        reader.onerror = function(err){ console.warn('Error leyendo archivo para guardar', err); alert('Error al leer el audio para guardarlo.'); };
        try { reader.readAsDataURL(file); } catch(e) { console.warn('No se pudo leer el archivo para guardarlo', e); alert('No se pudo guardar el audio.'); }
      }
    }

    /* ========== Reproducir / Pausar ========== */
    function playAudio(){
      const button = document.getElementById('playButton');
      const audioElement = audioFiles[currentQuestionIndex];
      if (!audioElement) {
        console.log('No hay audio disponible para esta pregunta');
        return;
      }
      if (audioElement.paused) {
        if (button) { button.textContent = '‚è∏'; button.style.background = 'linear-gradient(135deg,#f56565 0%,#e53e3e 100%)'; }
        audioElement.play().catch(error => {
          console.error('Error al reproducir audio:', error);
          if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; }
          alert('El navegador ha bloqueado la reproducci√≥n autom√°tica. Haz clic en el bot√≥n de reproducir otra vez despu√©s de interactuar con la p√°gina.');
        });
        audioElement.onended = () => {
          if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; }
        };
      } else {
        audioElement.pause();
        if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; }
      }
    }

    /* ========== Confetti peque√±o ========== */
    function createConfetti() {
      const colors = ['#667eea', '#764ba2', '#48bb78', '#f6e05e', '#fc8181'];
      const container = document.getElementById('pandaCelebration');
      if (!container) return;
      for (let i = 0; i < 20; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 90 + '%';
        confetti.style.top = Math.random() * 10 + 'px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDuration = (Math.random() * 1.2 + 1.6) + 's';
        container.appendChild(confetti);
        setTimeout(() => { if (confetti.parentNode) confetti.parentNode.removeChild(confetti); }, 3200);
      }
    }

    /* ========== Panda centered interaction ========= */
    function showPandaCelebration() {
      const container = document.getElementById('pandaCelebration');
      if (!container) return;
      container.innerHTML = '';
      const pandaWrap = document.createElement('div');
      pandaWrap.className = 'panda-center';
      pandaWrap.innerHTML = `<div class="panda-emoji">üêº</div><div class="panda-text">Â§™Ê£í‰∫ÜÔºÅ</div>`;
      container.appendChild(pandaWrap);
      createConfetti();
    }

    /* ========== Seleccionar respuesta ========= */
    async function selectAnswer(index) {
      if (answered && selectedAnswer === index) return;
      const question = questions[currentQuestionIndex];
      questionAttempts[question.id] = (questionAttempts[question.id] || 0) + 1;
      const attemptsIndicator = document.getElementById('attemptsIndicator');
      if (attemptsIndicator) attemptsIndicator.textContent = questionAttempts[question.id];
      const isCorrect = index === correctAnswerIndex;
      selectedAnswer = index;
      const optionsGrid = document.getElementById('optionsGrid');
      const buttons = optionsGrid ? optionsGrid.querySelectorAll('.option-button') : [];
      buttons.forEach(btn => btn.disabled = true);
      const selectedButton = document.getElementById(`option${index}`);
      if (selectedButton) selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
      const feedback = document.getElementById('feedback');

      if (isCorrect) {
        correctAnswers++;
        const firstTry = questionAttempts[question.id] === 1;
        if (firstTry && !firstTryCorrectByQuestion[question.id]) {
          firstTryCorrectCount++;
          firstTryCorrectByQuestion[question.id] = true;
        }
        answered = true;
        if (feedback) { feedback.className = 'feedback success'; feedback.textContent = ''; }
        showPandaCelebration();
        const nextBtn = document.getElementById('nextButton');
        if (nextBtn) nextBtn.style.display = 'inline-block';
        try {
          await recordResult({
            question_id: question.id,
            attempts: questionAttempts[question.id],
            correct: true,
            timestamp: new Date().toISOString(),
            game_session: gameSession,
            first_try: firstTry
          });
        } catch (e) { console.error('recordResult fallo:', e); }
      } else {
        if (feedback) { feedback.className = 'feedback error'; feedback.textContent = 'Vuelve a intentarlo'; }
        setTimeout(() => {
          if (feedback) feedback.textContent = '';
          if (selectedButton) selectedButton.classList.remove('incorrect');
          shuffleOptions(question);
          renderQuestion();
          document.querySelectorAll('.option-button').forEach(btn => btn.disabled = false);
          selectedAnswer = null;
        }, 900);
      }
    }

    /* ========== Opciones + next/restart ========= */
    function renderOptionsGrid(){
      const g = document.getElementById('optionsGrid');
      if(!g) return;
      g.innerHTML = shuffledOptions.map((o,i)=>`<button class="option-button" id="option${i}">${o}</button>`).join('');
      const btns = g.querySelectorAll('.option-button');
      btns.forEach((b, i) => {
        b.disabled = false;
        b.addEventListener('click', (ev)=> { ev.preventDefault(); selectAnswer(i); });
      });
    }

    function nextQuestion() {
      currentQuestionIndex++;
      shuffledOptions = [];
      if (currentQuestionIndex < questions.length) renderQuestion();
      else showResults();
    }

    function restartGame() {
      currentQuestionIndex = 0;
      gameSession = Date.now().toString();
      questionAttempts = {};
      correctAnswers = 0;
      firstTryCorrectCount = 0;
      firstTryCorrectByQuestion = {};
      answered = false;
      selectedAnswer = null;
      shuffledOptions = [];
      renderQuestion();
    }

    /* ========== Pantalla final de resultados ========= */
    function showResults() {
      const content = document.getElementById('gameContent');
      const totalAttempts = Object.values(questionAttempts).reduce((a,b)=>a+b,0);
      document.getElementById('progressFill').style.width = '100%';
      const perQuestionLines = questions.map((q, idx) => {
        const attempts = questionAttempts[q.id] || 0;
        return `<div style="display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#fff;margin-bottom:8px;box-shadow:0 6px 18px rgba(12,20,40,0.04)"><div><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong></div><div style="font-weight:700;color:#334155">${attempts}</div></div>`;
      }).join('');

      content.innerHTML = `
        <div style="text-align:center;padding:26px;">
          <div style="font-size:64px">üêºüéâ</div>
          <h2 style="margin:8px 0 6px">¬°Juego completado!</h2>

          <div style="margin-top:18px;text-align:left;max-width:720px;margin-left:auto;margin-right:auto">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#f8fafc,#ffffff);box-shadow:0 10px 30px rgba(11,22,48,0.04);margin-bottom:12px">
              <div>
                <div style="font-size:13px;color:#94a3b8">Respuestas acertadas</div>
                <div style="font-size:28px;font-weight:800;color:#667eea">${firstTryCorrectCount}/${questions.length}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:#94a3b8">Intentos totales</div>
                <div style="font-size:22px;font-weight:700;color:#2d3748">${totalAttempts}</div>
              </div>
            </div>

            <div style="font-size:15px;font-weight:700;margin-bottom:8px">Detalle intentos:</div>
            ${perQuestionLines}
          </div>

          <div style="margin-top:18px"><button onclick="restartGame()" style="padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;cursor:pointer">Jugar de nuevo</button></div>
        </div>
      `;

      const sessionSummary = {
        game_session: gameSession,
        date: (new Date()).toISOString(),
        correctAnswers,
        firstTryCorrectCount,
        totalQuestions: questions.length,
        attemptsByQuestion: questionAttempts,
        user_name: localStorage.getItem('juego_user_name')||'',
        user_group: localStorage.getItem('juego_user_group')||''
      };
      storeResultLocal({ session: sessionSummary });
    }

    /* ========== SDK mocks (si no existe) ========== */
    if (!window.dataSdk) {
      window.dataSdk = { async init(){ return { isOk: true }; }, async create(record){ console.log('mock save', record); return { isOk: true }; } };
    }

    async function initializeGame(){
      await loadAudioManifestAndPrefetch();
      loadSavedAudios();
      try { await window.dataSdk.init({ onDataChanged: ()=>{} }); } catch(e){ console.warn('dataSdk.init fallo', e); }
      renderQuestion();
    }

    /* ========== UI Contrase√±a y ADMIN ========== */
    const pwOverlay = document.getElementById('passwordOverlay');
    const pwInput = document.getElementById('passwordInput') || { value: '' }; // si no existe, fallback temporal
    const pwBtn = document.getElementById('passwordBtn');
    const pwError = document.getElementById('passwordError');
    const adminControls = document.getElementById('adminControls');
    const showPassword = document.getElementById('showPassword');
    const userNameInput = document.getElementById('userName');
    const userGroupInput = document.getElementById('userGroup');
    const adminPanel = document.getElementById('adminPanel');
    const adminIcon = document.getElementById('adminIcon');
    const adminAccessPanel = document.getElementById('adminAccessPanel');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const adminAccessBtn = document.getElementById('adminAccessBtn');
    const adminCloseBtn = document.getElementById('adminCloseBtn');
    const adminAccessError = document.getElementById('adminAccessError');

    function prefillUserInfo(){
      const storedName = localStorage.getItem('juego_user_name') || '';
      const storedGroup = localStorage.getItem('juego_user_group') || '';
      if(storedName && userNameInput) userNameInput.value = storedName;
      if(storedGroup && userGroupInput) userGroupInput.value = storedGroup;
    }

    if (showPassword) showPassword.addEventListener('change', ()=> { const pi = document.getElementById('passwordInput'); if(pi) pi.type = showPassword.checked ? 'text' : 'password'; });

    function showPasswordOverlay(){
      prefillUserInfo();
      if (pwOverlay) pwOverlay.style.display = 'flex';
      if (pwError) pwError.style.display = 'none';
      if (adminAccessPanel) adminAccessPanel.style.display = 'none';
      if (adminAccessError) adminAccessError.style.display = 'none';
      if (adminPasswordInput) adminPasswordInput.value = '';
      setTimeout(()=> { const n = document.getElementById('userName'); if(n) n.focus(); }, 150);
    }

    function startGame(admin=false){
      isAdminMode = admin;
      if (isAdminMode) {
        adminControls.style.visibility = 'visible';
        adminControls.setAttribute('aria-hidden','false');
        buildAdminAggregatedView();
        adminPanel.style.display = 'block';
      } else {
        adminControls.style.visibility = 'hidden';
        adminControls.setAttribute('aria-hidden','true');
        adminPanel.style.display = 'none';
        initializeGame();
      }

      // Attach admin controls handlers
      const showAdminResultsBtnEl = document.getElementById('showAdminResultsBtn');
      const downloadCsvBtnEl = document.getElementById('downloadCsvBtn');
      const downloadResultsBtnEl = document.getElementById('downloadResultsBtn');
      const exportAudiosBtnEl = document.getElementById('exportAudiosBtn');
      const openGameBtnEl = document.getElementById('openGameBtn');

      if (showAdminResultsBtnEl) {
        showAdminResultsBtnEl.onclick = () => {
          if (adminPanel.style.display === 'block') {
            adminPanel.style.display = 'none';
          } else {
            buildAdminAggregatedView();
            adminPanel.style.display = 'block';
            setTimeout(()=> adminPanel.scrollIntoView({behavior:'smooth'}), 120);
          }
        };
      }
      if (downloadCsvBtnEl) {
        downloadCsvBtnEl.onclick = () => exportCsv(getStoredResults(), 'resultados_juego_all.csv');
      }
      if (downloadResultsBtnEl) {
        downloadResultsBtnEl.onclick = () => {
          const data = getStoredResults();
          alert(`Registros locales: ${data.length}. Puedes exportarlos con "Exportar CSV".`);
        };
      }
      if (exportAudiosBtnEl) {
        exportAudiosBtnEl.onclick = () => {
          const items = [];
          for(let i=0;i<questions.length;i++){
            const name = localStorage.getItem(audioKeyName(i));
            const data = localStorage.getItem(audioKeyData(i));
            if(name && data) items.push({index:i,name,hasData:true});
            else if(name) items.push({index:i,name,hasData:false});
            else items.push({index:i,name:'(no cargado)',hasData:false});
          }
          alert('Estado audios: ' + items.map(it=>`Q${it.index+1}: ${it.name}${it.hasData ? ' (guardado)': ''}`).join(' | '));
        };
      }
      if (openGameBtnEl) {
        openGameBtnEl.onclick = () => {
          initializeGame();
        };
      }

      const name = document.getElementById('userName') ? normalizeInput(document.getElementById('userName').value) : '';
      const group = document.getElementById('userGroup') ? normalizeInput(document.getElementById('userGroup').value) : '';
      if (name) localStorage.setItem('juego_user_name', name);
      if (group) localStorage.setItem('juego_user_group', group);

      if (pwOverlay) pwOverlay.style.display = 'none';
    }

    // boton principal (usuario/alumns)
    if (pwBtn) {
      pwBtn.addEventListener('click', () => {
        const raw = (document.getElementById('passwordInput') ? document.getElementById('passwordInput').value : '') || '';
        const val = normalizeInput(raw);
        const name = normalizeInput(document.getElementById('userName') ? document.getElementById('userName').value : '');
        const group = normalizeInput(document.getElementById('userGroup') ? document.getElementById('userGroup').value : '');

        if(!name || !group){
          if(pwError){ pwError.textContent = 'Por favor, introduce Nombre usuario y Grupo'; pwError.style.display = 'block'; setTimeout(()=> pwError.style.display = 'none', 3000); }
          return;
        }
        if(name.length > 30){
          if(pwError){ pwError.textContent = 'El nombre no puede tener m√°s de 30 caracteres'; pwError.style.display = 'block'; setTimeout(()=> pwError.style.display = 'none', 3000); }
          return;
        }

        if(val === ADMIN_PASSWORD){
          startGame(true);
        } else if(val === STUDENT_PASSWORD){
          startGame(false);
        } else {
          if(pwError){ pwError.textContent = 'Contrase√±a incorrecta o campos incompletos'; pwError.style.display = 'block'; setTimeout(()=> pwError.style.display = 'none', 2500); }
        }
      });
    }

    // admin icon behavior
    if (adminIcon) adminIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      adminAccessPanel.style.display = adminAccessPanel.style.display === 'block' ? 'none' : 'block';
      adminAccessError.style.display = 'none';
    });
    if (adminCloseBtn) adminCloseBtn.addEventListener('click', ()=> { adminAccessPanel.style.display = 'none'; adminAccessError.style.display='none'; });

    if (adminAccessBtn) adminAccessBtn.addEventListener('click', ()=> {
      const v = normalizeInput(adminPasswordInput.value || '');
      if (v === ADMIN_PASSWORD) {
        adminAccessPanel.style.display = 'none';
        pwOverlay.style.display = 'none';
        startGame(true);
      } else {
        adminAccessError.style.display = 'block';
        setTimeout(()=> adminAccessError.style.display = 'none', 2400);
      }
    });

    function prefillUserFromStorage(){
      const n = localStorage.getItem('juego_user_name')||'';
      const g = localStorage.getItem('juego_user_group')||'';
      if(n && document.getElementById('userName')) document.getElementById('userName').value = n;
      if(g && document.getElementById('userGroup')) document.getElementById('userGroup').value = g;
    }

    window.addEventListener('DOMContentLoaded', () => {
      try {
        console.log('DOM cargado ‚Äî mostrando overlay de password...');
        prefillUserFromStorage();
        showPasswordOverlay();
        window.__juego = { audioFiles, audioFileNames, getStoredResults };
      } catch (e) {
        console.error('Error en DOMContentLoaded', e);
      }
    });

    /* ========== Admin aggregated view & stats (mejorado) ========== */
    function buildAdminAggregatedView(){
      const rows = getStoredResults();
      const panel = adminPanel;
      if(!rows || rows.length === 0){
        panel.innerHTML = `<div>No hay resultados todav√≠a.</div>`;
        return;
      }

      const explicitSessions = rows.filter(r => r && r.session).map(r => r.session).slice().reverse();
      const responseRecords = rows.filter(r => r && !r.session);

      // sintetitzar sessions a partir de respostes (agrupar per game_session)
      const sessionsById = {};
      responseRecords.forEach(r => {
        const sid = r.game_session || ('gen-' + (r.user_name || 'u') + '-' + (r.timestamp||''));
        if(!sessionsById[sid]) sessionsById[sid] = { game_session: sid, date: r.timestamp || '', user_name: r.user_name || '', user_group: r.user_group || '', attemptsByQuestion: {}, firstTryCorrectCount:0, correctAnswers:0 };
        const s = sessionsById[sid];
        s.attemptsByQuestion[r.question_id] = Math.max(s.attemptsByQuestion[r.question_id] || 0, r.attempts || 0);
        if(r.correct) s.correctAnswers = (s.correctAnswers||0) + 1;
        if(r.first_try) s.firstTryCorrectCount = (s.firstTryCorrectCount||0) + 1;
      });

      const explicitIds = new Set(explicitSessions.map(s=>s.game_session));
      const combined = explicitSessions.slice();
      Object.values(sessionsById).forEach(s => { if(!explicitIds.has(s.game_session)) combined.unshift(s); });

      let html = `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px"><button class="small-btn" id="exportAllCsv">Exportar CSV</button><button class="small-btn" id="clearResultsBtn">Borrar resultados locales</button></div>`;
      html += `<div id="adminStats"></div>`;
      html += `<div style="margin-top:10px">`;
      if(combined.length === 0){
        html += `<div>No hay sesiones registradas.</div>`;
      } else {
        combined.forEach(sess => {
          const dateStr = formatDateNice(sess.date);
          const user = sess.user_name || 'An√≥nimo';
          const group = sess.user_group || '';
          const totalCorrectFirstTry = typeof sess.firstTryCorrectCount === 'number' ? sess.firstTryCorrectCount : 0;
          const totalQuestions = sess.totalQuestions || questions.length;
          const attemptsByQ = sess.attemptsByQuestion || {};
          const detailHtml = questions.map((q, idx) => {
            const a = attemptsByQ[q.id] || '-';
            return `<div style="font-size:13px;color:#475569;margin-top:6px"><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong> ${a}</div>`;
          }).join('');
          html += `
            <div class="session-card">
              <div class="session-left">
                <div style="font-weight:700;color:#0f172a">${user} ${group ? '¬∑ ' + group : ''}</div>
                <div class="session-meta">Fecha: ${dateStr}</div>
                <div style="margin-top:8px">${detailHtml}</div>
              </div>
              <div class="session-right">
                <div class="session-meta">Aciertos (1.¬∫ intento)</div>
                <div class="session-stats">${totalCorrectFirstTry}/${totalQuestions}</div>
              </div>
            </div>
          `;
        });
      }
      html += `</div>`;
      panel.innerHTML = html;

      document.getElementById('exportAllCsv').addEventListener('click', ()=> exportCsv(getStoredResults(), 'resultados_juego_all.csv'));
      document.getElementById('clearResultsBtn').addEventListener('click', ()=>{
        if(confirm('¬øBorrar todos los resultados guardados localmente? Esta acci√≥n no se puede deshacer.')){
          localStorage.removeItem(RESULTS_KEY);
          buildAdminAggregatedView();
        }
      });

      renderAdminStats(rows, combined);
    }

    function renderAdminStats(allRows, combinedSessions){
      const statsContainer = document.getElementById('adminStats');
      if(!statsContainer) return;
      const responseRecords = allRows.filter(r => r && !r.session);
      const explicitSessions = allRows.filter(r => r && r.session).map(r => r.session);

      // Comptem nom√©s els ERRORS totals (attempts - 1) des de responseRecords
      const totalErrorsPerQuestion = {};
      responseRecords.forEach(r => {
        if (!r || !r.question_id) return;
        const attemptsNum = Number(r.attempts || 0);
        if (attemptsNum > 1) {
          // sumar nom√©s (attempts - 1) perqu√® 1 = acierto en 1er intento (0 errores)
          totalErrorsPerQuestion[r.question_id] = (totalErrorsPerQuestion[r.question_id] || 0) + (attemptsNum - 1);
        }
      });

      // fallback: si no hi ha responseRecords, intentar usar explicitSessions
      if (Object.keys(totalErrorsPerQuestion).length === 0 && explicitSessions.length > 0) {
        explicitSessions.forEach(s => {
          if (!s.attemptsByQuestion) return;
          Object.keys(s.attemptsByQuestion).forEach(qid => {
            const a = Number(s.attemptsByQuestion[qid] || 0);
            if (a > 1) {
              totalErrorsPerQuestion[qid] = (totalErrorsPerQuestion[qid] || 0) + (a - 1);
            }
          });
        });
      }

      let worstQid = null; let worstAttempts = 0;
      Object.keys(totalErrorsPerQuestion).forEach(qid => {
        if (totalErrorsPerQuestion[qid] > worstAttempts) { worstAttempts = totalErrorsPerQuestion[qid]; worstQid = qid; }
      });

      const firstTryCorrectsPerQuestion = {};
      responseRecords.forEach(r => {
        if(!r.question_id) return;
        if(r.first_try) firstTryCorrectsPerQuestion[r.question_id] = (firstTryCorrectsPerQuestion[r.question_id] || 0) + 1;
      });
      let bestQid = null; let bestCount = 0;
      Object.keys(firstTryCorrectsPerQuestion).forEach(qid => {
        if (firstTryCorrectsPerQuestion[qid] > bestCount) { bestCount = firstTryCorrectsPerQuestion[qid]; bestQid = qid; }
      });

      const sessionsCount = explicitSessions.length || combinedSessions.length;
      const sessionsByUser = {};
      explicitSessions.forEach(s => {
        const u = s.user_name || 'An√≥nimo';
        sessionsByUser[u] = sessionsByUser[u] || new Set();
        sessionsByUser[u].add(s.game_session || (s.date || Math.random()));
      });
      combinedSessions.forEach(s => {
        const u = s.user_name || 'An√≥nimo';
        sessionsByUser[u] = sessionsByUser[u] || new Set();
        sessionsByUser[u].add(s.game_session || (s.date || Math.random()));
      });
      const uniqueUsers = Object.keys(sessionsByUser).length;
      const avgGamesPerUser = uniqueUsers === 0 ? 0 : (sessionsCount / uniqueUsers);

      const worstLabel = worstQid ? (questions.find(q=>q.id===worstQid)?.shortTitle || worstQid) : 'N/A';
      const bestLabel = bestQid ? (questions.find(q=>q.id===bestQid)?.shortTitle || bestQid) : 'N/A';
      const worstLabelDisplay = worstAttempts ? `${worstAttempts} errores` : '-';
      const bestCountDisplay = bestQid ? `${bestCount} aciertos (1.¬∫ intento)` : '-';

      statsContainer.innerHTML = `
        <div id="adminStatsInner" style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="min-width:220px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.04)">
            <div style="font-size:12px;color:#94a3b8">Sesiones registradas</div>
            <div style="font-weight:800;font-size:20px;color:#334155">${sessionsCount}</div>
          </div>
          <div style="min-width:220px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.04)">
            <div style="font-size:12px;color:#94a3b8">Usuarios √∫nicos</div>
            <div style="font-weight:800;font-size:20px;color:#334155">${uniqueUsers}</div>
          </div>
          <div style="min-width:240px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.04)">
            <div style="font-size:12px;color:#94a3b8">Media de partidas por usuario</div>
            <div style="font-weight:800;font-size:20px;color:#334155">${avgGamesPerUser.toFixed(2)}</div>
          </div>
          <div style="min-width:260px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.04)">
            <div style="font-size:12px;color:#94a3b8">Pregunta m√°s fallada</div>
            <div style="font-weight:800;font-size:18px;color:#b91c1c">${worstLabel} ‚Äî ${worstLabelDisplay}</div>
          </div>
          <div style="min-width:260px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.04)">
            <div style="font-size:12px;color:#94a3b8">Pregunta m√°s acertada</div>
            <div style="font-weight:800;font-size:18px;color:#15803d">${bestLabel} ‚Äî ${bestCountDisplay}</div>
          </div>
        </div>
      `;
    }

    function formatDateNice(iso){
      if(!iso) return '-';
      try {
        const d = new Date(iso);
        const opts = { weekday: 'short', day: '2-digit', month: 'short', hour:'2-digit', minute:'2-digit' };
        const loc = navigator.language || 'es-ES';
        return d.toLocaleString(loc, opts);
      } catch(e){ return iso; }
    }

    function exportCsv(data, filename = 'resultados.csv'){
      if(!data || !data.length){ alert('No hay datos para exportar'); return; }
      const rows = [];
      rows.push(['user_name','user_group','type','question','attempts','correct','first_try','timestamp','game_session']);
      data.forEach(r=>{
        if(r.session){
          rows.push([r.session.user_name||'', r.session.user_group||'', 'session_summary', '', '', '', '', r.session.date||'', r.session.game_session||'']);
        } else {
          rows.push([r.user_name||'', r.user_group||'', 'respuesta', r.question_title||r.question_id||'', r.attempts||'', r.correct? '1':'0', r.first_try? '1':'0', r.timestamp||'', r.game_session||'']);
        }
      });
      const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ========== Protecci√≥n y debugging ========= */
    window.addEventListener('error', function(ev){
      console.error('Unhandled error:', ev.error || ev.message || ev);
      try{
        const el = document.getElementById('gameContent');
        if(el && !document.getElementById('debugErrorBanner')){
          const b = document.createElement('div'); b.id='debugErrorBanner'; b.style.background='#fee2e2'; b.style.color='#7f1d1d'; b.style.padding='8px'; b.style.borderRadius='6px'; b.style.margin='10px'; b.textContent = 'Error en la aplicaci√≥n ‚Äî mira la consola (F12) para m√°s detalles.'; el.prepend(b);
        }
      }catch(e){}
    });

    // Exponer funciones √∫tiles globalmente (per proves)
    window.buildAdminAggregatedView = buildAdminAggregatedView;
    window.getStoredResults = getStoredResults;
    window.restartGame = restartGame;

  })();
  </script>
</body>
</html>
