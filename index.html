<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="es">
  <meta name="language" content="es">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de Pronunciaci√≥n China</title>
  <style>
    /* Estilos principales */
    *, *:before, *:after { box-sizing: border-box; }
    body{margin:0;padding:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .container{width:90%;max-width:900px;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:24px 40px;margin:20px;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:24px;font-weight:700;color:#2d3748}
    .instructions{font-size:14px;color:#718096}
    .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width .3s ease;width:0%}
    .question-card{background:#f7fafc;border-radius:16px;padding:20px;margin-bottom:18px}
    .question-title{font-size:18px;font-weight:600;color:#2d3748;margin-bottom:12px}
    .audio-player{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:16px;padding:14px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .audio-controls{display:flex;align-items:center;gap:12px}
    .play-button{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .play-button:disabled{opacity:.5;cursor:not-allowed}
    .options-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .option-button{padding:12px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:500;color:#2d3748;cursor:pointer;text-align:left;white-space:pre-wrap}
    .option-button.correct{background:#48bb78;border-color:#48bb78;color:#fff}
    .option-button.incorrect{background:#f56565;border-color:#f56565;color:#fff}
    .feedback{ text-align:center;padding:12px;border-radius:10px;margin-bottom:12px;font-size:16px;font-weight:600}
    .feedback.success{background:#c6f6d5;color:#22543d}
    .feedback.error{background:#fed7d7;color:#742a2a}
    .next-button{padding:12px 18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:12px;color:#fff;font-size:15px;cursor:pointer}
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:13px}
    .small-muted{font-size:12px;color:#94a3b8;text-align:center;margin-top:6px}
    .hidden{display:none!important}

    /* Modal contrase√±a */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:200; }
    .password-card { background: white; padding: 18px; border-radius: 12px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .password-card h2 { margin: 6px 0 8px; font-size:18px; }
    .password-input { width:100%; max-width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:12px; font-size:14px; }
    .password-btn { width:100%; padding:12px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .password-error { color:#f56565; margin-top:8px; display:none; }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" aria-live="polite">
    <div class="header">
      <div>
        <div class="title" id="gameTitle">Juego de Pronunciaci√≥n China</div>
        <div class="instructions" id="instructionsText">Escucha el audio y selecciona la respuesta correcta</div>
      </div>

      <!-- Panel admin: oculto per defecte, visible en mode admin -->
      <div id="adminControls" style="visibility:hidden">
        <button class="small-btn" id="exportAudiosBtn">Exportar audios</button>
        <button class="small-btn" id="downloadResultsBtn">Descargar resultados</button>
        <button class="small-btn" id="downloadCsvBtn">Exportar CSV</button>
      </div>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

    <div id="gameContent"></div>

    <div class="small-muted" style="margin-top:12px">Tus resultados se mandar√°n autom√°ticamente a la profesora para su evaluaci√≥n</div>
  </div>

  <!-- Modal contrase√±a -->
  <div id="passwordOverlay" class="overlay" style="display:none;">
    <div class="password-card" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h2 id="pwTitle">Introduce la contrase√±a</h2>
      <!-- He eliminado la frase explicativa solicitada -->
      <input id="passwordInput" class="password-input" type="password" placeholder="Introduce la contrase√±a">
      <button id="passwordBtn" class="password-btn">Empezar</button>
      <div id="passwordError" class="password-error">Contrase√±a incorrecta</div>
    </div>
  </div>

  <script>
    /* ==================== CONFIGURACI√ìN: dos contrase√±as ==================== */
    // Contrase√±a alumnos (solo juegan)
    const STUDENT_PASSWORD = "PANDAR√çN25";
    // Contrase√±a profesora/admin (activa controls d'admin)
    const ADMIN_PASSWORD = "XUXITO25";

    // URL del manifest d'√†udios (posar la teva URL p√∫blica aqu√≠)
    const GAME_AUDIO_MANIFEST_URL = "https://TU_HOSTING_PUBLIC/audios_manifest.json";

    /* ==================== RESTO DEL JOC (simplificat / adaptat) ==================== */
    const defaultConfig = {
      success_message: "¬°Excelente!",
      error_message: "Vuelve a intentarlo",
      complete_message: "¬°Juego completado!"
    };

    const questions = [
      {
        id: "q1_yi",
        title: "1. Escucha solo los 'yi' y escoge en qu√© orden aparecen",
        audioPlaceholder: "",
        options: [
          "Y√¨ y√¨ y√¨ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨",
          "Y√≠ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨",
          "Yƒ´ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨"
        ],
        correctIndex: 2
      },
      {
        id: "q2_yi_jq",
        title: "2. Escucha Yi+jq y escoge el orden correcto",
        audioPlaceholder: "",
        options: [
          "yƒ´j√≠ yƒ´q«ê yƒ´qƒ´ y√≠j√≠",
          "y√≠jƒ´ yƒ´q√≠ yƒ´jƒ´ yƒ´q«ê",
          "yƒ´q«ê yƒ´qƒ´ yƒ´j√≠ y«êj√≠"
        ],
        correctIndex: 0
      },
      {
        id: "q3_jqx",
        title: "3. Reconoce las palabras con j-q-x y su orden de aparici√≥n",
        audioPlaceholder: "",
        options: [
          "xq q x x q x x j x j x j j jj q j",
          "xq x q q q x x j x j x j j jj j j",
          "xq x q q q j j j x j x j j jj x x",
          "xq x q q q x x j x j x j j jj j q"
        ],
        correctIndex: 3
      }
    ];

    /* ==================== Estado del juego ==================== */
    let currentQuestionIndex = 0;
    let gameSession = Date.now().toString();
    let questionAttempts = {};
    let correctAnswers = 0;
    let answered = false;
    let selectedAnswer = null;
    let shuffledOptions = [];
    let correctAnswerIndex = 0;
    let audioFiles = {};       // { idx: HTMLAudioElement }
    let audioFileNames = {};   // { idx: filename }
    let isAdminMode = false;

    const RESULTS_KEY = 'juego_results';
    function audioKeyData(idx){ return `juego_audio_data_q${idx}`; }
    function audioKeyName(idx){ return `juego_audio_name_q${idx}`; }

    /* ==================== Utilidades ==================== */
    function shuffleArray(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
    function shuffleOptions(question) {
      const opts = [...question.options];
      const correct = opts[question.correctIndex];
      shuffleArray(opts);
      correctAnswerIndex = opts.indexOf(correct);
      shuffledOptions = opts;
      return { options: shuffledOptions, correctIndex: correctAnswerIndex };
    }

    /* ==================== Persistencia audio local (opcional) ==================== */
    function saveAudioToLocal(questionIndex, dataUrl, filename){
      try {
        localStorage.setItem(audioKeyData(questionIndex), dataUrl);
        localStorage.setItem(audioKeyName(questionIndex), filename);
        const audioEl = document.createElement('audio');
        audioEl.src = dataUrl;
        audioEl.preload = 'auto';
        audioFiles[questionIndex] = audioEl;
        audioFileNames[questionIndex] = filename;
        return true;
      } catch (e) {
        console.warn('No se pudo guardar audio en localStorage:', e);
        return false;
      }
    }
    function loadSavedAudios(){
      for (let i = 0; i < questions.length; i++){
        const data = localStorage.getItem(audioKeyData(i));
        const name = localStorage.getItem(audioKeyName(i));
        if (data && name){
          try {
            const audioEl = document.createElement('audio');
            audioEl.src = data;
            audioEl.preload = 'auto';
            audioFiles[i] = audioEl;
            audioFileNames[i] = name;
          } catch(err){ console.warn(err); }
        }
      }
    }

    /* ==================== Cargar manifest p√∫blic i guardar localmente ==================== */
    async function fetchAsDataURL(url){
      try {
        const r = await fetch(url, { mode: 'cors' });
        if (!r.ok) throw new Error('fetch failed ' + r.status);
        const blob = await r.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = (e) => rej(e);
          reader.readAsDataURL(blob);
        });
      } catch (e) {
        console.warn('fetchAsDataURL error', e);
        return null;
      }
    }
    async function loadAudioManifestAndPrefetch(){
      if (!GAME_AUDIO_MANIFEST_URL) return;
      try {
        const res = await fetch(GAME_AUDIO_MANIFEST_URL, { cache: 'no-cache' });
        if (!res.ok) { console.warn('No se pudo cargar manifest', res.status); return; }
        const manifest = await res.json();
        for (const key of Object.keys(manifest)){
          const idx = Number(key);
          if (Number.isNaN(idx) || idx < 0 || idx >= questions.length) continue;
          const entry = manifest[key];
          if (!entry || !entry.url) continue;
          const localData = localStorage.getItem(audioKeyData(idx));
          const localName = localStorage.getItem(audioKeyName(idx));
          if (localData && localName) {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = localData;
              audioEl.preload = 'auto';
              audioFiles[idx] = audioEl;
              audioFileNames[idx] = localName;
              continue;
            } catch (e) { console.warn(e); }
          }
          const dataUrl = await fetchAsDataURL(entry.url);
          if (dataUrl) {
            const saved = saveAudioToLocal(idx, dataUrl, entry.name || entry.url.split('/').pop());
            if (!saved) {
              try {
                const audioEl = document.createElement('audio');
                audioEl.src = entry.url;
                audioEl.preload = 'auto';
                audioFiles[idx] = audioEl;
                audioFileNames[idx] = entry.name || entry.url.split('/').pop();
              } catch(e){}
            }
          } else {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = entry.url;
              audioEl.preload = 'auto';
              audioFiles[idx] = audioEl;
              audioFileNames[idx] = entry.name || entry.url.split('/').pop();
            } catch(e){}
          }
        }
      } catch (err) { console.error('Error cargando manifest', err); }
    }

    /* ==================== Registro resultados local + dataSdk stub ==================== */
    function getStoredResults(){ try { const raw = localStorage.getItem(RESULTS_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
    function storeResultLocal(record){ try { const arr = getStoredResults(); arr.push(record); localStorage.setItem(RESULTS_KEY, JSON.stringify(arr)); } catch(e){ console.warn(e); } }
    async function recordResult(record){ try { await window.dataSdk.create(record).catch(()=>{}); } catch(e){} storeResultLocal(record); }

    /* ==================== Render y l√≥gica del juego ==================== */
    function renderQuestion(reshuffleOptions = true) {
      const content = document.getElementById('gameContent');
      const question = questions[currentQuestionIndex];
      if (!questionAttempts[question.id]) questionAttempts[question.id] = 0;
      if (reshuffleOptions || shuffledOptions.length === 0) shuffleOptions(question);
      const progress = ((currentQuestionIndex) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      const hasAudio = !!audioFiles[currentQuestionIndex];
      const audioFileName = audioFileNames[currentQuestionIndex] || '';
      let audioUploadSection = '';
      let playButtonAttr = hasAudio ? '' : 'disabled';
      if (hasAudio && audioFileName) {
        audioUploadSection = `<div style="font-size:12px;color:#48bb78">‚úÖ Audio cargado: ${audioFileName}</div>`;
      } else {
        audioUploadSection = `<div style="font-size:13px;color:#4a5568">No hay audio disponible.</div>`;
      }
      content.innerHTML = `
        <div class="question-card" role="region" aria-label="Pregunta ${currentQuestionIndex + 1}">
          <div class="question-title">${question.title}</div>
          <div class="audio-player">${audioUploadSection}<div class="audio-controls"><button class="play-button" id="playButton" onclick="playAudio()" ${playButtonAttr}>‚ñ∂</button></div></div>
          <div class="options-grid" id="optionsGrid"></div>
          <div id="feedback" aria-live="polite"></div>
          <div id="pandaCelebration" style="min-height:120px"></div>
          <div style="margin-top:8px;text-align:center;font-size:12px;color:#718096">Intentos en esta pregunta: <span id="attemptsIndicator">${questionAttempts[question.id]}</span></div>
          <div style="display:flex;gap:10px;margin-top:12px;"><button class="next-button" id="nextButton" style="display:none" onclick="nextQuestion()">${currentQuestionIndex < questions.length - 1 ? 'Siguiente Pregunta' : 'Ver Resultados'}</button><button class="small-btn" id="skipBtn">Saltar pregunta</button></div>
        </div>
      `;
      renderOptionsGrid();
      answered = false;
      selectedAnswer = null;
      const skipBtn = document.getElementById('skipBtn');
      if (skipBtn){
        skipBtn.onclick = () => {
          recordResult({question_id: question.id, attempts: questionAttempts[question.id], correct: false, skipped: true, timestamp: new Date().toISOString(), game_session: gameSession});
          currentQuestionIndex++;
          shuffledOptions = [];
          if (currentQuestionIndex < questions.length) renderQuestion();
          else showResults();
        };
      }
      setTimeout(()=> { const firstOpt = document.querySelector('.option-button'); if (firstOpt) firstOpt.focus(); }, 60);
    }
    function renderOptionsGrid(){
      const optionsGrid = document.getElementById('optionsGrid');
      if (!optionsGrid) return;
      optionsGrid.innerHTML = shuffledOptions.map((option, index) => `
        <button class="option-button" onclick="selectAnswer(${index})" id="option${index}" aria-pressed="false">
          ${option}
        </button>
      `).join('');
      document.querySelectorAll('.option-button').forEach(btn => { btn.disabled = false; btn.setAttribute('aria-disabled','false'); });
    }
    function playAudio() {
      const button = document.getElementById('playButton');
      const audioElement = audioFiles[currentQuestionIndex];
      if (!audioElement) { console.log('No hay audio disponible para esta pregunta'); return; }
      if (audioElement.paused) {
        if (button) { button.textContent = '‚è∏'; button.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)'; }
        audioElement.play().catch(error => { console.error('Error al reproducir audio:', error); if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; }});
        audioElement.onended = () => { if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; } };
      } else {
        audioElement.pause();
        if (button) { button.textContent = '‚ñ∂'; button.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)'; }
      }
    }
    async function selectAnswer(index) {
      if (answered && selectedAnswer === index) return;
      const question = questions[currentQuestionIndex];
      questionAttempts[question.id] = (questionAttempts[question.id] || 0) + 1;
      const attemptsIndicator = document.getElementById('attemptsIndicator');
      if (attemptsIndicator) attemptsIndicator.textContent = `${questionAttempts[question.id]}`;
      const isCorrect = index === correctAnswerIndex;
      selectedAnswer = index;
      const optionsGrid = document.getElementById('optionsGrid');
      const buttons = optionsGrid ? optionsGrid.querySelectorAll('.option-button') : [];
      buttons.forEach(btn => { btn.disabled = true; btn.setAttribute('aria-disabled','true'); });
      const selectedButton = document.getElementById(`option${index}`);
      if (selectedButton) selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
      const feedback = document.getElementById('feedback');
      if (isCorrect) {
        correctAnswers++;
        answered = true;
        if (feedback) { feedback.className = 'feedback success'; feedback.textContent = defaultConfig.success_message; }
        const pandaCelebration = document.getElementById('pandaCelebration');
        if (pandaCelebration) pandaCelebration.innerHTML = 'üêº<div style="font-weight:700;margin-top:6px">¬°Buen trabajo!</div>';
        const nextBtn = document.getElementById('nextButton');
        if (nextBtn) nextBtn.style.display = 'block';
        await recordResult({ question_id: question.id, attempts: questionAttempts[question.id], correct: true, skipped: false, timestamp: new Date().toISOString(), game_session: gameSession });
      } else {
        if (feedback) { feedback.className = 'feedback error'; feedback.textContent = defaultConfig.error_message; }
        setTimeout(() => {
          if (feedback) feedback.textContent = '';
          if (selectedButton) selectedButton.classList.remove('incorrect');
          shuffleOptions(question);
          renderOptionsGrid();
          document.querySelectorAll('.option-button').forEach(btn => { btn.disabled = false; btn.setAttribute('aria-disabled','false'); });
          selectedAnswer = null;
        }, 900);
      }
    }
    function nextQuestion() { currentQuestionIndex++; shuffledOptions = []; if (currentQuestionIndex < questions.length) renderQuestion(); else showResults(); }
    function showResults() {
      const content = document.getElementById('gameContent');
      const totalAttempts = Object.values(questionAttempts).reduce((a,b)=>a+b,0);
      const accuracy = Math.round((correctAnswers / questions.length) * 100);
      document.getElementById('progressFill').style.width = '100%';
      content.innerHTML = `
        <div style="text-align:center;padding:20px;">
          <div style="font-size:64px">üêºüéâ</div>
          <h2>${defaultConfig.complete_message}</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:18px 0;">
            <div style="background:#f7fafc;padding:12px;border-radius:10px"><div style="font-size:28px;font-weight:700;color:#667eea">${correctAnswers}/${questions.length}</div><div style="font-size:12px;color:#718096">Respuestas correctas</div></div>
            <div style="background:#f7fafc;padding:12px;border-radius:10px"><div style="font-size:28px;font-weight:700;color:#667eea">${totalAttempts}</div><div style="font-size:12px;color:#718096">Intentos totales</div></div>
          </div>
          <div style="margin-top:8px"><button onclick="restartGame()" style="padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;cursor:pointer">Jugar de nuevo</button></div>
        </div>
      `;
      const sessionSummary = { game_session: gameSession, date: (new Date()).toISOString(), correctAnswers, totalQuestions: questions.length, attemptsByQuestion: questionAttempts };
      storeResultLocal({ session: sessionSummary });
    }
    function restartGame() { currentQuestionIndex = 0; gameSession = Date.now().toString(); questionAttempts = {}; correctAnswers = 0; answered = false; selectedAnswer = null; shuffledOptions = []; renderQuestion(); }

    /* ==================== SDK mocks ==================== */
    if (!window.dataSdk) {
      window.dataSdk = { async init(){ return { isOk: true }; }, async create(record){ console.log('mock save', record); return { isOk: true }; } };
    }

    /* ==================== Inicializaci√≥n ==================== */
    async function initializeGame() {
      await loadAudioManifestAndPrefetch();
      loadSavedAudios();
      try { await window.dataSdk.init({ onDataChanged: ()=>{} }); } catch(e){ console.warn('dataSdk.init fallo', e); }
      renderQuestion();
    }

    /* ==================== Contrase√±a UI (dos contrasenyes) ==================== */
    const pwOverlay = document.getElementById('passwordOverlay');
    const pwInput = document.getElementById('passwordInput');
    const pwBtn = document.getElementById('passwordBtn');
    const pwError = document.getElementById('passwordError');
    const adminControls = document.getElementById('adminControls');

    function showPasswordOverlay() {
      // Siempre mostrar modal al cargar; si quieres auto-login sin contrase√±a, cambia esta l√≥gica
      pwOverlay.style.display = 'flex';
      pwInput.value = '';
      pwError.style.display = 'none';
      pwInput.focus();
    }

    function startGame(admin = false) {
      isAdminMode = admin;
      if (isAdminMode) {
        adminControls.style.visibility = 'visible';
        adminControls.setAttribute('aria-hidden','false');
      } else {
        adminControls.style.visibility = 'hidden';
        adminControls.setAttribute('aria-hidden','true');
      }
      pwOverlay.style.display = 'none';
      initializeGame();
    }

    pwBtn.addEventListener('click', () => {
      const val = pwInput.value || '';
      if (val === ADMIN_PASSWORD) {
        startGame(true); // admin
      } else if (val === STUDENT_PASSWORD) {
        startGame(false); // alumno
      } else {
        pwError.style.display = 'block';
        setTimeout(()=> pwError.style.display = 'none', 2500);
      }
    });

    pwInput.addEventListener('keyup', (e)=> { if (e.key === 'Enter') pwBtn.click(); });

    window.addEventListener('DOMContentLoaded', () => {
      showPasswordOverlay();
      window.__juego = { audioFiles, audioFileNames, getStoredResults };
    });

    /* ==================== Atajos de teclado ==================== */
    window.addEventListener('keydown', (e) => {
      const active = document.activeElement;
      if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;
      if (e.code === 'Space') { e.preventDefault(); playAudio(); }
      if (['Digit1','Numpad1','Digit2','Numpad2','Digit3','Numpad3','Digit4','Numpad4'].includes(e.code)){
        let idx = null;
        if (e.code.includes('1')) idx = 0;
        else if (e.code.includes('2')) idx = 1;
        else if (e.code.includes('3')) idx = 2;
        else if (e.code.includes('4')) idx = 3;
        if (idx !== null){ const btn = document.getElementById(`option${idx}`); if (btn && !btn.disabled) btn.click(); }
      }
      if (e.key.toLowerCase() === 's') { const skipBtn = document.getElementById('skipBtn'); if (skipBtn) skipBtn.click(); }
    });

  </script>
</body>
</html>
