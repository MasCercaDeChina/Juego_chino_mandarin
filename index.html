<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de pronunciaci칩n</title>
<style>
/* Aqu칤 van tus estilos existentes */
</style>
</head>
<body>
<div id="passwordOverlay"> <!-- overlay de password --> </div>
<div id="gameContent">Juego de pronunciaci칩n<br>Escucha el audio y selecciona la respuesta correcta<br>Tus resultados se mandar치n autom치ticamente a la profesora para su evaluaci칩n</div>
<div id="adminPanel" style="display:none"></div>
<div id="pandaCelebration"></div>
<script>
(function(){

  /* ================= Configuraci칩n de audios ================= */
  const audioFiles = {};
  const audioFileNames = ["T1_Yi","Yi_jq","T1_J_Q_X"];

  async function loadAudioManifestAndPrefetch(){
    try{
      const res = await fetch('audio_manifest.json');
      const manifest = await res.json();
      manifest.forEach(item => {
        // corregir noms amb _ i ordre correcte
        if(audioFileNames.includes(item.name)){
          audioFiles[item.name] = new Audio(item.url);
          audioFiles[item.name].preload = 'auto';
        }
      });
    } catch(e){ console.error('Error cargando audios:',e); }
  }

  function loadSavedAudios(){
    // opcional, si guardes audios al localStorage
  }

  /* ==================== Funciones de juego ==================== */
  let questions = [];
  let currentQuestionIndex = 0;
  let questionAttempts = {};
  let correctAnswers = 0;
  let firstTryCorrectCount = 0;
  let firstTryCorrectByQuestion = {};
  let answered = false;
  let selectedAnswer = null;
  let shuffledOptions = [];
  let gameSession = Date.now().toString();

  // Aqu칤 ir칤an tus preguntas y l칩gica previa

  function showPandaCelebration() {
    const container = document.getElementById('pandaCelebration');
    if (!container) return;
    container.innerHTML = '';
    const pandaWrap = document.createElement('div');
    pandaWrap.className = 'panda-center';
    pandaWrap.innerHTML = `<div class="panda-emoji">游냪</div><div class="panda-text">邏쀥뉛줁庸</div>`;
    container.appendChild(pandaWrap);
    createConfetti();
  }

  window.selectAnswer = async function(index){
    // L칩gica igual a la que ten칤as
  };

  function renderOptionsGrid(){ /* Igual */ }
  window.nextQuestion = function(){ /* Igual */ };
  window.restartGame = function(){ /* Igual */ };

  /* ==================== Resultados finales ==================== */
  function showResults(){
    const content = document.getElementById('gameContent');
    const totalAttempts = Object.values(questionAttempts).reduce((a,b)=>a+b,0);
    document.getElementById('progressFill')?.style.width='100%';

    // Per pregunta detalle
    const perQuestionLines = questions.map((q, idx)=>{
      const attempts = questionAttempts[q.id] || 0;
      return `<div style="display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#fff;margin-bottom:8px;box-shadow:0 6px 18px rgba(12,20,40,0.04)"><div><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong></div><div style="font-weight:700;color:#334155">${attempts}</div></div>`;
    }).join('');

    content.innerHTML = `
      <div style="text-align:center;padding:26px;">
        <div style="font-size:64px">游냪游꿀</div>
        <h2 style="margin:8px 0 6px">춰Juego completado!</h2>
        <div style="margin-top:18px;text-align:left;max-width:720px;margin-left:auto;margin-right:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#f8fafc,#ffffff);box-shadow:0 10px 30px rgba(11,22,48,0.04);margin-bottom:12px">
            <div>
              <div style="font-size:13px;color:#94a3b8">Respuestas acertadas</div>
              <div style="font-size:28px;font-weight:800;color:#667eea">${firstTryCorrectCount}/${questions.length}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:13px;color:#94a3b8">Intentos totales</div>
              <div style="font-size:22px;font-weight:700;color:#2d3748">${totalAttempts}</div>
            </div>
          </div>
          <div style="font-size:15px;font-weight:700;margin-bottom:8px">Detalle intentos:</div>
          ${perQuestionLines}
        </div>
        <div style="margin-top:18px"><button onclick="restartGame()" style="padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;cursor:pointer">Jugar de nuevo</button></div>
      </div>
    `;

    storeResultLocal({ session: { game_session: gameSession, date:(new Date()).toISOString(), correctAnswers, firstTryCorrectCount, totalQuestions: questions.length, attemptsByQuestion: questionAttempts, user_name: localStorage.getItem('juego_user_name')||'', user_group: localStorage.getItem('juego_user_group')||'' } });
  }

  /* ==================== Admin & estad칤sticas ==================== */
  function buildAdminAggregatedView(){
    const rows = getStoredResults();
    const panel = adminPanel;
    if(!rows || rows.length === 0){ panel.innerHTML=`<div>No hay resultados todav칤a.</div>`; return; }

    // Sumar s칩lo errores >1 por pregunta para la m치s fallada
    const totalErrorsPerQuestion = {};
    rows.filter(r=>!r.session).forEach(r=>{
      if(r.attempts>1) totalErrorsPerQuestion[r.question_id] = (totalErrorsPerQuestion[r.question_id]||0)+r.attempts;
    });

    let worstQid=null,worstAttempts=0;
    Object.keys(totalErrorsPerQuestion).forEach(qid=>{
      if(totalErrorsPerQuestion[qid]>worstAttempts){ worstAttempts=totalErrorsPerQuestion[qid]; worstQid=qid; }
    });

    // Resto igual que tu l칩gica existente, usando worstQid y worstAttempts

  }

  /* ==================== Inicializaci칩n ==================== */
  async function initializeGame(){
    await loadAudioManifestAndPrefetch();
    loadSavedAudios();
    try{ await window.dataSdk?.init({onDataChanged:()=>{}}); }catch(e){console.warn(e);}
    renderQuestion();
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    showPasswordOverlay();
  });

})();
</script>
</body>
</html>
