<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="es">
  <meta name="language" content="es">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de pronunciaci√≥n</title>
  <style>
    /* Estilos principales */
    *, *:before, *:after { box-sizing: border-box; }
    body{margin:0;padding:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .container{width:90%;max-width:900px;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:24px 40px;margin:20px;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    .title{font-size:24px;font-weight:700;color:#2d3748}
    .instructions{font-size:14px;color:#718096}
    .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width .3s ease;width:0%}
    .question-card{background:#f7fafc;border-radius:16px;padding:20px;margin-bottom:18px}
    .question-title{font-size:18px;font-weight:600;color:#2d3748;margin-bottom:12px}
    .audio-player{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:16px;padding:14px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .audio-controls{display:flex;align-items:center;gap:12px}
    .play-button{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .play-button:disabled{opacity:.5;cursor:not-allowed}
    .options-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .option-button{padding:12px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:500;color:#2d3748;cursor:pointer;text-align:left;white-space:pre-wrap;transition:transform .12s}
    .option-button:hover:not(:disabled){transform:translateY(-3px)}
    .option-button.correct{background:#48bb78;border-color:#48bb78;color:#fff}
    .option-button.incorrect{background:#f56565;border-color:#f56565;color:#fff}
    .feedback{ text-align:center;padding:12px;border-radius:10px;margin-bottom:12px;font-size:16px;font-weight:600}
    .feedback.success{background:#c6f6d5;color:#22543d}
    .feedback.error{background:#fed7d7;color:#742a2a}
    .next-button{padding:12px 18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:12px;color:#fff;font-size:15px;cursor:pointer}
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:13px}
    .small-muted{font-size:12px;color:#94a3b8;text-align:center;margin-top:6px}
    .hidden{display:none!important}

    /* Panda celebration centered, grande y animado */
    .panda-center {
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:8px;
      width:100%;
      text-align:center;
      margin:8px 0 4px;
    }
    .panda-center .panda-emoji {
      font-size:140px;
      line-height:1;
      transform-origin:center center;
      animation: pandaPop .9s cubic-bezier(.2,.9,.2,1);
      user-select:none;
    }
    .panda-center .panda-text {
      font-size:22px;
      font-weight:800;
      color:#2d3748;
      letter-spacing:0.6px;
    }
    @keyframes pandaPop {
      0% { transform: scale(.4) translateY(40px); opacity:0 }
      50% { transform: scale(1.08) translateY(-6px); opacity:1 }
      80% { transform: scale(.96) translateY(2px) }
      100% { transform: scale(1) translateY(0) }
    }

    /* confetti */
    .confetti { position: absolute; width: 10px; height: 10px; border-radius:2px; z-index:99; animation:confettiFall linear forwards; pointer-events:none; }
    @keyframes confettiFall { 0%{ transform: translateY(-30px) rotate(0); opacity:1 } 100%{ transform: translateY(160px) rotate(360deg); opacity:0 } }

    /* Admin results panel */
    #adminPanel { margin-top:14px; padding:12px; border-radius:12px; background:#f8fafc; display:none; max-height:60vh; overflow:auto; border:1px solid #e6edf8; }
    #adminPanel table { width:100%; border-collapse:collapse; font-size:13px; }
    #adminPanel th, #adminPanel td { padding:6px 8px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:top; }
    #adminPanel th { background:#f1f5f9; position:sticky; top:0; z-index:2; }

    /* Modal contrase√±a */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:200; }
    .password-card { background: white; padding: 18px; border-radius: 12px; width: 92%; max-width: 480px; text-align: left; box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .password-card h2 { margin: 6px 0 8px; font-size:18px; text-align:center; }
    .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
    label { font-size:13px; color:#475569; }
    .password-input, .text-input, .select-input { width:100%; max-width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; }
    .password-actions { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .password-btn { width:100%; padding:12px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .password-error { color:#f56565; margin-top:8px; display:none; text-align:center; }

    @media (max-width:520px){
      .password-card{ padding:14px; }
      .container{ padding:18px; }
      .panda-center .panda-emoji { font-size:110px; }
      .panda-center .panda-text { font-size:18px; }
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" aria-live="polite">
    <div class="header">
      <div>
        <div class="title" id="gameTitle">Juego de pronunciaci√≥n</div>
        <div class="instructions" id="instructionsText">Escucha el audio y selecciona la respuesta correcta</div>
      </div>

      <!-- Panel admin: oculto per defecte, visible en mode admin -->
      <div id="adminControls" style="visibility:hidden; display:flex; gap:8px; align-items:center;">
        <button class="small-btn" id="exportAudiosBtn">Exportar audios</button>
        <button class="small-btn" id="downloadResultsBtn">Descargar resultados</button>
        <button class="small-btn" id="downloadCsvBtn">Exportar CSV</button>
        <button class="small-btn" id="showAdminResultsBtn">Ver resultados</button>
      </div>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

    <div id="gameContent"></div>

    <div class="small-muted" style="margin-top:12px">Tus resultados se mandar√°n autom√°ticamente a la profesora para su evaluaci√≥n</div>

    <!-- Panel admin on-page -->
    <div id="adminPanel" aria-live="polite"></div>
  </div>

  <!-- Modal contrase√±a + formulario de usuario -->
  <div id="passwordOverlay" class="overlay" style="display:none;">
    <div class="password-card" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h2 id="pwTitle">Introduce la contrase√±a</h2>

      <div class="form-row">
        <label for="userName">Nombre usuario (m√°x. 30 caracteres)</label>
        <input id="userName" class="text-input" type="text" placeholder="Ej. Mar√≠a P√©rez" aria-label="Nombre usuario" maxlength="30">
      </div>

      <div class="form-row">
        <label for="userGroup">Grupo</label>
        <select id="userGroup" class="select-input" aria-label="Grupo">
          <option value="">-- Selecciona grupo --</option>
          <option value="PANDARIN1">PANDARIN1</option>
          <option value="PANDARIN2">PANDARIN2</option>
          <option value="PANDARIN3">PANDARIN3</option>
        </select>
      </div>

      <div class="form-row">
        <label for="passwordInput">Contrase√±a</label>
        <input id="passwordInput" class="password-input" type="password" placeholder="Introduce la contrase√±a" aria-label="Contrase√±a">
      </div>

      <div class="password-actions">
        <label style="display:flex;align-items:center;gap:8px"><input id="showPassword" type="checkbox" aria-label="Mostrar contrase√±a"> Mostrar contrase√±a</label>
        <div style="flex:1"></div>
      </div>

      <button id="passwordBtn" class="password-btn">Empezar</button>
      <div id="passwordError" class="password-error">Contrase√±a incorrecta o campos incompletos</div>
    </div>
  </div>

  <script>
    /* ==================== CONFIGURACI√ìN: dos contrase√±as ==================== */
    const STUDENT_PASSWORD = "PANDAR√çN25".normalize('NFC');
    const ADMIN_PASSWORD   = "XUXITO25".normalize('NFC');

    // URL del manifest d'√†udios (posar la teva URL p√∫blica aqu√≠)
    const GAME_AUDIO_MANIFEST_URL = "https://TU_HOSTING_PUBLIC/audios_manifest.json";

    /* ==================== Dades i estat del joc ==================== */
    const defaultConfig = {
      success_message: "¬°Excelente!",
      error_message: "Vuelve a intentarlo",
      complete_message: "¬°Juego completado!"
    };

    const questions = [
      { id: "q1_yi", title: "1. Escucha solo los 'yi' y escoge en qu√© orden aparecen", shortTitle: "Yi",
        options: ["Y√¨ y√¨ y√¨ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Y√≠ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Yƒ´ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨"], correctIndex:2 },
      { id: "q2_yi_jq", title: "2. Escucha Yi+jq y escoge el orden correcto", shortTitle: "Yi + jq",
        options: ["yƒ´j√≠ yƒ´q«ê yƒ´qƒ´ y√≠j√≠","y√≠jƒ´ yƒ´q√≠ yƒ´jƒ´ yƒ´q«ê","yƒ´q«ê yƒ´qƒ´ yƒ´j√≠ y«êj√≠"], correctIndex:0 },
      { id: "q3_jqx", title: "3. Reconoce las palabras con j-q-x y su orden de aparici√≥n", shortTitle: "J-Q-X",
        options: ["xq q x x q x x j x j x j j jj q j","xq x q q q x x j x j x j j jj j j","xq x q q q j j j x j x j j jj x x","xq x q q q x x j x j x j j jj j q"], correctIndex:3 }
    ];

    let currentQuestionIndex = 0;
    let gameSession = Date.now().toString();
    let questionAttempts = {};
    let correctAnswers = 0; // total correct (any attempt)
    let firstTryCorrectCount = 0; // correcta en primer intent
    let firstTryCorrectByQuestion = {}; // { questionId: true/false }
    let answered = false;
    let selectedAnswer = null;
    let shuffledOptions = [];
    let correctAnswerIndex = 0;
    let audioFiles = {};
    let audioFileNames = {};
    let isAdminMode = false;

    const RESULTS_KEY = 'juego_results';
    function audioKeyData(idx){ return `juego_audio_data_q${idx}`; }
    function audioKeyName(idx){ return `juego_audio_name_q${idx}`; }

    /* ==================== Utilidades ==================== */
    function shuffleArray(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
    function shuffleOptions(question) {
      const opts = [...question.options];
      const correct = opts[question.correctIndex];
      shuffleArray(opts);
      correctAnswerIndex = opts.indexOf(correct);
      shuffledOptions = opts;
      return { options: shuffledOptions, correctIndex: correctAnswerIndex };
    }

    /* ==================== Persistencia audios ==================== */
    function saveAudioToLocal(questionIndex, dataUrl, filename){
      try {
        localStorage.setItem(audioKeyData(questionIndex), dataUrl);
        localStorage.setItem(audioKeyName(questionIndex), filename);
        const audioEl = document.createElement('audio');
        audioEl.src = dataUrl;
        audioEl.preload = 'auto';
        audioFiles[questionIndex] = audioEl;
        audioFileNames[questionIndex] = filename;
        return true;
      } catch (e) { console.warn('No se pudo guardar audio en localStorage:', e); return false; }
    }
    function loadSavedAudios(){
      for (let i = 0; i < questions.length; i++){
        const data = localStorage.getItem(audioKeyData(i));
        const name = localStorage.getItem(audioKeyName(i));
        if (data && name){
          try {
            const audioEl = document.createElement('audio');
            audioEl.src = data;
            audioEl.preload = 'auto';
            audioFiles[i] = audioEl;
            audioFileNames[i] = name;
          } catch(err){ console.warn(err); }
        }
      }
    }

    /* ==================== Prefetch manifest ==================== */
    async function fetchAsDataURL(url){
      try {
        const r = await fetch(url, { mode: 'cors' });
        if (!r.ok) throw new Error('fetch failed ' + r.status);
        const blob = await r.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = (e) => rej(e);
          reader.readAsDataURL(blob);
        });
      } catch (e) { console.warn('fetchAsDataURL error', e); return null; }
    }
    async function loadAudioManifestAndPrefetch(){
      if (!GAME_AUDIO_MANIFEST_URL) return;
      try {
        const res = await fetch(GAME_AUDIO_MANIFEST_URL, { cache: 'no-cache' });
        if (!res.ok) { console.warn('No se pudo cargar manifest', res.status); return; }
        const manifest = await res.json();
        for (const key of Object.keys(manifest)){
          const idx = Number(key);
          if (Number.isNaN(idx) || idx < 0 || idx >= questions.length) continue;
          const entry = manifest[key];
          if (!entry || !entry.url) continue;
          const localData = localStorage.getItem(audioKeyData(idx));
          const localName = localStorage.getItem(audioKeyName(idx));
          if (localData && localName) {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = localData;
              audioEl.preload = 'auto';
              audioFiles[idx] = audioEl;
              audioFileNames[idx] = localName;
              continue;
            } catch (e) { console.warn(e); }
          }
          const dataUrl = await fetchAsDataURL(entry.url);
          if (dataUrl) {
            const saved = saveAudioToLocal(idx, dataUrl, entry.name || entry.url.split('/').pop());
            if (!saved) {
              try {
                const audioEl = document.createElement('audio');
                audioEl.src = entry.url;
                audioEl.preload = 'auto';
                audioFiles[idx] = audioEl;
                audioFileNames[idx] = entry.name || entry.url.split('/').pop();
              } catch(e){}
            }
          } else {
            try {
              const audioEl = document.createElement('audio');
              audioEl.src = entry.url;
              audioEl.preload = 'auto';
              audioFiles[idx] = audioEl;
              audioFileNames[idx] = entry.name || entry.url.split('/').pop();
            } catch(e){}
          }
        }
      } catch (err) { console.error('Error cargando manifest', err); }
    }

    /* ==================== Result storage ==================== */
    function getStoredResults(){ try { const raw = localStorage.getItem(RESULTS_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
    function storeResultLocal(record){ try { const arr = getStoredResults(); arr.push(record); localStorage.setItem(RESULTS_KEY, JSON.stringify(arr)); } catch(e){ console.warn(e); } }
    async function recordResult(record){
      // Afegim info d'usuari al registre
      const user_name = localStorage.getItem('juego_user_name') || '';
      const user_group = localStorage.getItem('juego_user_group') || '';
      const question = questions.find(q=>q.id===record.question_id);
      const rec = Object.assign({}, record, { user_name, user_group, question_title: question ? question.shortTitle : record.question_id });
      try { await window.dataSdk.create(rec).catch(()=>{}); } catch(e){}
      storeResultLocal(rec);
    }

    /* ==================== Render / game logic ==================== */
    function renderQuestion(reshuffleOptions = true) {
      const content = document.getElementById('gameContent');
      const question = questions[currentQuestionIndex];
      if (!questionAttempts[question.id]) questionAttempts[question.id] = 0;
      if (reshuffleOptions || shuffledOptions.length === 0) shuffleOptions(question);
      document.getElementById('progressFill').style.width = ((currentQuestionIndex)/questions.length*100)+'%';
      const hasAudio = !!audioFiles[currentQuestionIndex];
      const audioFileName = audioFileNames[currentQuestionIndex] || '';
      let audioSection = hasAudio && audioFileName ? `<div style="font-size:12px;color:#48bb78">‚úÖ Audio cargado: ${audioFileName}</div>` : `<div style="font-size:13px;color:#4a5568">No hay audio disponible.</div>`;
      content.innerHTML = `
        <div class="question-card" role="region" aria-label="Pregunta ${currentQuestionIndex+1}">
          <div class="question-title">${question.title}</div>
          <div class="audio-player">${audioSection}<div class="audio-controls"><button class="play-button" id="playButton" onclick="playAudio()" ${hasAudio ? '' : 'disabled'} aria-label="Reproducir audio">‚ñ∂</button></div></div>
          <div class="options-grid" id="optionsGrid"></div>
          <div id="feedback" aria-live="polite"></div>
          <div id="pandaCelebration" style="min-height:160px; position:relative;"></div>
          <div style="margin-top:8px;text-align:center;font-size:12px;color:#718096">Intentos en esta pregunta: <span id="attemptsIndicator">${questionAttempts[question.id]}</span></div>
          <div style="display:flex;gap:10px;margin-top:12px;"><button class="next-button" id="nextButton" style="display:none" onclick="nextQuestion()">${currentQuestionIndex < questions.length-1 ? 'Siguiente Pregunta' : 'Ver Resultados'}</button></div>
        </div>
      `;
      renderOptionsGrid();
      answered=false; selectedAnswer=null;
      setTimeout(()=> { const f=document.querySelector('.option-button'); if(f) f.focus(); }, 40);
    }

    function renderOptionsGrid(){
      const g = document.getElementById('optionsGrid'); if(!g) return;
      g.innerHTML = shuffledOptions.map((o,i)=>`<button class="option-button" id="option${i}" onclick="selectAnswer(${i})">${o}</button>`).join('');
      document.querySelectorAll('.option-button').forEach(b=>{ b.disabled=false; b.setAttribute('aria-disabled','false'); });
    }

    function playAudio(){
      const btn=document.getElementById('playButton');
      const a = audioFiles[currentQuestionIndex];
      if(!a){ console.log('No audio'); return; }
      if(a.paused){ if(btn){btn.textContent='‚è∏'; btn.style.background='linear-gradient(135deg,#f56565 0%,#e53e3e 100%)';} a.play().catch(e=>{console.error(e); if(btn){btn.textContent='‚ñ∂'; btn.style.background='linear-gradient(135deg,#667eea 0%,#764ba2 100%)';}}); a.onended=()=>{ if(btn){btn.textContent='‚ñ∂'; btn.style.background='linear-gradient(135deg,#667eea 0%,#764ba2 100%)';}} } else { a.pause(); if(btn){btn.textContent='‚ñ∂'; btn.style.background='linear-gradient(135deg,#667eea 0%,#764ba2 100%)';} }
    }

    /* ========== Panda celebration helper (centred + confetti) ========== */
    function showPandaCelebration() {
      const container = document.getElementById('pandaCelebration');
      if(!container) return;
      // clear existing
      container.innerHTML = '';
      // panda centered markup with chinese text
      const pandaWrap = document.createElement('div');
      pandaWrap.className = 'panda-center';
      pandaWrap.innerHTML = `<div class="panda-emoji">üêº</div><div class="panda-text">Â§™Ê£í‰∫ÜÔºÅ</div>`;
      container.appendChild(pandaWrap);
      // confetti burst
      createConfettiBurst(container);
    }

    function createConfettiBurst(container){
      const colors = ['#667eea', '#764ba2', '#48bb78', '#f6e05e', '#fc8181'];
      for (let i = 0; i < 26; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = (10 + Math.random() * 80) + '%';
        confetti.style.top = (10 + Math.random() * 6) + 'px';
        confetti.style.background = colors[Math.floor(Math.random()*colors.length)];
        confetti.style.animationDuration = (Math.random() * 1.2 + 1.4) + 's';
        confetti.style.transform = `translateY(-10px) rotate(${Math.random()*360}deg)`;
        container.appendChild(confetti);
        setTimeout(()=> { if(confetti.parentNode) confetti.parentNode.removeChild(confetti); }, 3200);
      }
    }

    async function selectAnswer(index){
      if(answered && selectedAnswer===index) return;
      const q = questions[currentQuestionIndex];
      questionAttempts[q.id] = (questionAttempts[q.id]||0)+1;
      document.getElementById('attemptsIndicator').textContent = questionAttempts[q.id];
      const isCorrect = index === correctAnswerIndex;
      selectedAnswer = index;
      const buttons = document.querySelectorAll('.option-button'); buttons.forEach(b=>{ b.disabled=true; b.setAttribute('aria-disabled','true'); });
      const btn = document.getElementById(`option${index}`); if(btn) btn.classList.add(isCorrect ? 'correct' : 'incorrect');
      const feedback = document.getElementById('feedback');

      if(isCorrect){
        correctAnswers++;
        const firstTry = questionAttempts[q.id] === 1;
        if(firstTry && !firstTryCorrectByQuestion[q.id]){
          firstTryCorrectCount++;
          firstTryCorrectByQuestion[q.id] = true;
        }
        answered = true;
        if(feedback){ feedback.className='feedback success'; feedback.textContent = ''; } // we show central panda instead
        showPandaCelebration();
        const nextBtn = document.getElementById('nextButton'); if(nextBtn) nextBtn.style.display='block';
        await recordResult({ question_id: q.id, attempts: questionAttempts[q.id], correct: true, skipped:false, first_try: firstTry, timestamp: (new Date()).toISOString(), game_session: gameSession });
      } else {
        if(feedback){ feedback.className='feedback error'; feedback.textContent = defaultConfig.error_message; }
        setTimeout(()=>{
          if(feedback) feedback.textContent='';
          if(btn) btn.classList.remove('incorrect');
          // re-barajar opciones si se equivoca
          shuffleOptions(q);
          renderOptionsGrid();
          document.querySelectorAll('.option-button').forEach(b=>{ b.disabled=false; b.setAttribute('aria-disabled','false'); });
          selectedAnswer = null;
        }, 900);
      }
    }

    function nextQuestion(){ currentQuestionIndex++; shuffledOptions=[]; if(currentQuestionIndex<questions.length) renderQuestion(); else showResults(); }

    /* ========== Result screen (shows firstTryCorrectCount as "Respuestas acertadas") ========= */
    function showResults(){
      const content = document.getElementById('gameContent');
      const totalAttempts = Object.values(questionAttempts).reduce((a,b)=>a+b,0);
      document.getElementById('progressFill').style.width = '100%';

      // Desglose por pregunta (intentos)
      const perQuestionLines = questions.map((q, idx) => {
        const attempts = questionAttempts[q.id] || 0;
        return `<div style="display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#fff;margin-bottom:8px;box-shadow:0 6px 18px rgba(12,20,40,0.04)"><div><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong></div><div style="font-weight:700;color:#334155">${attempts}</div></div>`;
      }).join('');

      content.innerHTML = `
        <div style="text-align:center;padding:26px;">
          <div style="font-size:64px">üêºüéâ</div>
          <h2 style="margin:8px 0 6px">${defaultConfig.complete_message}</h2>

          <div style="margin-top:18px;text-align:left;max-width:720px;margin-left:auto;margin-right:auto">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#f8fafc,#ffffff);box-shadow:0 10px 30px rgba(11,22,48,0.04);margin-bottom:12px">
              <div>
                <div style="font-size:13px;color:#94a3b8">Respuestas acertadas</div>
                <div style="font-size:28px;font-weight:800;color:#667eea">${firstTryCorrectCount}/${questions.length}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:#94a3b8">Intentos totales</div>
                <div style="font-size:22px;font-weight:700;color:#2d3748">${totalAttempts}</div>
              </div>
            </div>

            <div style="font-size:15px;font-weight:700;margin-bottom:8px">Detalle intentos:</div>
            ${perQuestionLines}
          </div>

          <div style="margin-top:18px"><button onclick="restartGame()" style="padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;cursor:pointer">Jugar de nuevo</button></div>
        </div>
      `;

      // guardem sessi√≥ resum com a registre (incloem firstTryCorrectCount)
      const sessionSummary = {
        game_session: gameSession,
        date: (new Date()).toISOString(),
        correctAnswers,
        firstTryCorrectCount,
        totalQuestions: questions.length,
        attemptsByQuestion: questionAttempts,
        user_name: localStorage.getItem('juego_user_name')||'',
        user_group: localStorage.getItem('juego_user_group')||''
      };
      storeResultLocal({ session: sessionSummary });
    }

    function restartGame(){
      currentQuestionIndex = 0;
      gameSession = Date.now().toString();
      questionAttempts = {};
      correctAnswers = 0;
      firstTryCorrectCount = 0;
      firstTryCorrectByQuestion = {};
      answered = false;
      selectedAnswer = null;
      shuffledOptions = [];
      renderQuestion();
    }

    /* ==================== SDK mocks ==================== */
    if (!window.dataSdk) {
      window.dataSdk = { async init(){ return { isOk: true }; }, async create(record){ console.log('mock save', record); return { isOk: true }; } };
    }

    /* ==================== Inicializaci√≥n ==================== */
    async function initializeGame(){
      await loadAudioManifestAndPrefetch();
      loadSavedAudios();
      try { await window.dataSdk.init({ onDataChanged: ()=>{} }); } catch(e){ console.warn('dataSdk.init fallo', e); }
      renderQuestion();
    }

    /* ==================== Helpers input/normalization ==================== */
    function normalizeInput(s){ if(!s) return ''; return s.replace(/[\u200B-\u200D\uFEFF]/g,'').trim().normalize('NFC'); }

    /* ==================== Contrase√±a UI y formulario ==================== */
    const pwOverlay = document.getElementById('passwordOverlay');
    const pwInput = document.getElementById('passwordInput');
    const pwBtn = document.getElementById('passwordBtn');
    const pwError = document.getElementById('passwordError');
    const adminControls = document.getElementById('adminControls');
    const showPassword = document.getElementById('showPassword');
    const userNameInput = document.getElementById('userName');
    const userGroupInput = document.getElementById('userGroup');
    const adminPanel = document.getElementById('adminPanel');

    // Pre-fill desde localStorage
    function prefillUserInfo(){
      const storedName = localStorage.getItem('juego_user_name') || '';
      const storedGroup = localStorage.getItem('juego_user_group') || '';
      if(storedName) userNameInput.value = storedName;
      if(storedGroup) userGroupInput.value = storedGroup;
    }

    showPassword.addEventListener('change', ()=> { pwInput.type = showPassword.checked ? 'text' : 'password'; });

    function showPasswordOverlay(){
      pwOverlay.style.display = 'flex';
      pwInput.value = '';
      pwError.style.display = 'none';
      prefillUserInfo();
      setTimeout(()=> userNameInput.focus(), 200);
    }

    // START GAME: tambi√©n atamos aqu√≠ los handlers admin para asegurarnos que existen
    function startGame(admin=false){
      isAdminMode = admin;
      if(isAdminMode){
        adminControls.style.visibility = 'visible';
        adminControls.setAttribute('aria-hidden','false');
      } else {
        adminControls.style.visibility = 'hidden';
        adminControls.setAttribute('aria-hidden','true');
      }

      // Attach admin button handlers (safe: elements exist in DOM)
      const showAdminResultsBtnEl = document.getElementById('showAdminResultsBtn');
      const downloadCsvBtnEl = document.getElementById('downloadCsvBtn');
      const downloadResultsBtnEl = document.getElementById('downloadResultsBtn');
      const exportAudiosBtnEl = document.getElementById('exportAudiosBtn');

      if (showAdminResultsBtnEl) {
        showAdminResultsBtnEl.onclick = () => {
          if (adminPanel.style.display === 'block') {
            adminPanel.style.display = 'none';
          } else {
            buildAdminTable();
            adminPanel.style.display = 'block';
          }
        };
      }
      if (downloadCsvBtnEl) {
        downloadCsvBtnEl.onclick = () => exportCsv(getStoredResults(), 'resultados_juego_all.csv');
      }
      if (downloadResultsBtnEl) {
        downloadResultsBtnEl.onclick = () => {
          const data = getStoredResults();
          alert(`Registros locales: ${data.length}. Puedes usar "Ver resultados" para verlos o "Exportar CSV" para descargarlos.`);
        };
      }
      if (exportAudiosBtnEl) {
        exportAudiosBtnEl.onclick = () => {
          const items = [];
          for(let i=0;i<questions.length;i++){
            const name = localStorage.getItem(audioKeyName(i));
            const data = localStorage.getItem(audioKeyData(i));
            if(name && data) items.push({index:i,name,hasData:true});
            else if(name) items.push({index:i,name,hasData:false});
            else items.push({index:i,name:'(no cargado)',hasData:false});
          }
          alert('Estado audios: ' + items.map(it=>`Q${it.index+1}: ${it.name}${it.hasData ? ' (guardado)': ''}`).join(' | '));
        };
      }

      // guardar info d'usuari a localStorage (recorda entre sessions)
      const name = normalizeInput(userNameInput.value);
      const group = normalizeInput(userGroupInput.value);
      if (name) localStorage.setItem('juego_user_name', name);
      if (group) localStorage.setItem('juego_user_group', group);

      pwOverlay.style.display = 'none';
      initializeGame();
    }

    pwBtn.addEventListener('click', ()=>{
      const rawPass = pwInput.value || '';
      const val = normalizeInput(rawPass);
      const name = normalizeInput(userNameInput.value);
      const group = normalizeInput(userGroupInput.value);

      if(!name || !group){
        pwError.textContent = 'Por favor, introduce Nombre usuario y Grupo';
        pwError.style.display = 'block';
        setTimeout(()=> pwError.style.display='none', 3000);
        return;
      }
      if(name.length > 30){
        pwError.textContent = 'El nombre no puede tener m√°s de 30 caracteres';
        pwError.style.display = 'block';
        setTimeout(()=> pwError.style.display='none', 3000);
        return;
      }

      if(val === ADMIN_PASSWORD){
        startGame(true);
      } else if(val === STUDENT_PASSWORD){
        startGame(false);
      } else {
        pwError.textContent = 'Contrase√±a incorrecta o campos incompletos';
        pwError.style.display = 'block';
        setTimeout(()=> pwError.style.display='none', 2500);
      }
    });

    pwInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') pwBtn.click(); });
    userNameInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') pwInput.focus(); });
    userGroupInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') pwInput.focus(); });

    window.addEventListener('DOMContentLoaded', ()=>{
      showPasswordOverlay();
      window.__juego = { audioFiles, audioFileNames, getStoredResults };
    });

    /* ==================== Admin panel rendering & CSV export ==================== */
    function buildAdminTable(){
      const rows = getStoredResults();
      if(rows.length === 0){
        adminPanel.innerHTML = `<div>No hay resultados todav√≠a.</div>`;
        return;
      }
      let html = `<div style="display:flex;gap:8px;margin-bottom:8px;"><button class="small-btn" id="exportAllCsv">Exportar todos CSV</button><button class="small-btn" id="clearResultsBtn">Borrar resultados locales</button></div>`;
      html += `<table><thead><tr><th>usuario</th><th>grupo</th><th>tipo</th><th>pregunta</th><th>intentos</th><th>correcto</th><th>first_try</th><th>timestamp</th><th>sesi√≥n</th></tr></thead><tbody>`;
      rows.slice().reverse().forEach(r=>{
        if(r.session){
          const s = r.session;
          html += `<tr><td>${r.session.user_name||''}</td><td>${r.session.user_group||''}</td><td>session_summary</td><td>-</td><td>-</td><td>-</td><td>-</td><td>${s.date}</td><td>${s.game_session}</td></tr>`;
        } else {
          html += `<tr><td>${r.user_name||''}</td><td>${r.user_group||''}</td><td>respuesta</td><td>${r.question_title||r.question_id||''}</td><td>${r.attempts||''}</td><td>${r.correct? 'S√≠':'No'}</td><td>${r.first_try? 'S√≠':''}</td><td>${r.timestamp||''}</td><td>${r.game_session||''}</td></tr>`;
        }
      });
      html += `</tbody></table>`;
      adminPanel.innerHTML = html;

      document.getElementById('exportAllCsv').addEventListener('click', ()=> exportCsv(getStoredResults(), 'resultados_juego_all.csv'));
      document.getElementById('clearResultsBtn').addEventListener('click', ()=>{
        if(confirm('¬øBorrar todos los resultados guardados localmente? Esta acci√≥n no se puede deshacer.')){
          localStorage.removeItem(RESULTS_KEY);
          buildAdminTable();
        }
      });
    }

    function exportCsv(data, filename = 'resultados.csv'){
      if(!data || !data.length){ alert('No hay datos para exportar'); return; }
      const rows = [];
      rows.push(['user_name','user_group','type','question','attempts','correct','first_try','timestamp','game_session']);
      data.forEach(r=>{
        if(r.session){
          rows.push([r.session.user_name||'', r.session.user_group||'', 'session_summary', '', '', '', '', r.session.date||'', r.session.game_session||'']);
        } else {
          rows.push([r.user_name||'', r.user_group||'', 'respuesta', r.question_title||r.question_id||'', r.attempts||'', r.correct? '1':'0', r.first_try? '1':'0', r.timestamp||'', r.game_session||'']);
        }
      });
      const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>
