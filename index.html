<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="es">
  <meta name="language" content="es">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de pronunciaci√≥n</title>
  <style>
    /* (Estilos redu√Øts per brevetat; copia els mateixos estils que ja tens) */
    *, *:before, *:after { box-sizing: border-box; }
    body{margin:0;padding:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .container{width:90%;max-width:1000px;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:24px 40px;margin:20px;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    .title{font-size:24px;font-weight:700;color:#2d3748}
    .instructions{font-size:14px;color:#718096}
    .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width .3s ease;width:0%}
    .question-card{background:#f7fafc;border-radius:16px;padding:20px;margin-bottom:18px}
    .audio-player{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:16px;padding:14px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .play-button{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .options-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .option-button{padding:12px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:500;color:#2d3748;cursor:pointer;text-align:left;white-space:pre-wrap;transition:transform .12s}
    .option-button.correct{background:#48bb78;border-color:#48bb78;color:#fff}
    .option-button.incorrect{background:#f56565;border-color:#f56565;color:#fff}
    .panda-center { display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; width:100%; text-align:center; margin:8px 0 4px; }
    .panda-center .panda-emoji { font-size:140px; line-height:1; transform-origin:center center; animation: pandaPop .9s cubic-bezier(.2,.9,.2,1); user-select:none; }
    .panda-center .panda-text { font-size:22px; font-weight:800; color:#2d3748; letter-spacing:0.6px; }
    @keyframes pandaPop { 0%{transform:scale(.4) translateY(40px);opacity:0}50%{transform:scale(1.08) translateY(-6px);opacity:1}80%{transform:scale(.96) translateY(2px)}100%{transform:scale(1) translateY(0)} }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:200; }
    .password-card { background: white; padding: 18px; border-radius: 12px; width: 92%; max-width: 480px; text-align: left; box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .password-input, .text-input, .select-input { width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; }
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #cbd5e0;background:#fff;cursor:pointer;font-size:13px}
    #adminPanel { margin-top:14px; padding:12px; border-radius:12px; background:#f8fafc; display:none; max-height:60vh; overflow:auto; border:1px solid #e6edf8; }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" aria-live="polite">
    <div class="header">
      <div>
        <div class="title" id="gameTitle">Juego de pronunciaci√≥n</div>
        <div class="instructions" id="instructionsText">Escucha el audio y selecciona la respuesta correcta</div>
      </div>
      <div id="adminControls" style="visibility:hidden; display:flex; gap:8px; align-items:center;">
        <button class="small-btn" id="exportAudiosBtn">Estado audios</button>
        <button class="small-btn" id="downloadResultsBtn">Info resultados</button>
        <button class="small-btn" id="downloadCsvBtn">Exportar CSV</button>
        <button class="small-btn" id="showAdminResultsBtn">Ver resultados</button>
      </div>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div id="gameContent"></div>
    <div class="small-muted" style="margin-top:12px">Tus resultados se mandar√°n autom√°ticamente a la profesora para su evaluaci√≥n</div>
    <div id="adminPanel" aria-live="polite"></div>
  </div>

  <!-- Modal contrase√±a + formulario -->
  <div id="passwordOverlay" class="overlay" style="display:none;">
    <div class="password-card" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h2 id="pwTitle">Introduce la contrase√±a</h2>

      <div style="margin-bottom:10px">
        <label for="userName">Nombre usuario (m√°x. 30 caracteres)</label>
        <input id="userName" class="text-input" type="text" placeholder="Ej. Mar√≠a P√©rez" aria-label="Nombre usuario" maxlength="30">
      </div>

      <div style="margin-bottom:10px">
        <label for="userGroup">Grupo</label>
        <select id="userGroup" class="select-input" aria-label="Grupo">
          <option value="">-- Selecciona grupo --</option>
          <option value="PANDARIN1">PANDARIN1</option>
          <option value="PANDARIN2">PANDARIN2</option>
          <option value="PANDARIN3">PANDARIN3</option>
        </select>
      </div>

      <div style="margin-bottom:10px">
        <label for="passwordInput">Contrase√±a</label>
        <input id="passwordInput" class="password-input" type="password" placeholder="Introduce la contrase√±a" aria-label="Contrase√±a">
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
        <label style="display:flex;align-items:center;gap:8px"><input id="showPassword" type="checkbox" aria-label="Mostrar contrase√±a"> Mostrar contrase√±a</label>
        <div style="flex:1"></div>
      </div>

      <button id="passwordBtn" class="small-btn" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;">Empezar</button>
      <div id="passwordError" style="color:#f56565;margin-top:8px;display:none;text-align:center;">Contrase√±a incorrecta o campos incompletos</div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    console.log('Juego script inicializado');

    const STUDENT_PASSWORD = "PANDAR√çN25".normalize('NFC');
    const ADMIN_PASSWORD   = "XUXITO25".normalize('NFC');
    const GAME_AUDIO_MANIFEST_URL = ""; // opcional: pon la URL si la uses
    const QUESTIONS = [
      { id: "q1_yi", title: "1. Escucha solo los 'yi' y escoge en qu√© orden aparecen", shortTitle: "Yi",
        options: ["Y√¨ y√¨ y√¨ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Y√≠ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨","Yƒ´ yƒ´ yƒ´ y√¨ yƒ´ y√≠ y√¨ y«ê y√¨ y√¨"], correctIndex:2 },
      { id: "q2_yi_jq", title: "2. Escucha Yi+jq y escoge el orden correcto", shortTitle: "Yi + jq",
        options: ["yƒ´j√≠ yƒ´q«ê yƒ´qƒ´ y√≠j√≠","y√≠jƒ´ yƒ´q√≠ yƒ´jƒ´ yƒ´q«ê","yƒ´q«ê yƒ´qƒ´ yƒ´j√≠ y«êj√≠"], correctIndex:0 },
      { id: "q3_jqx", title: "3. Reconoce las palabras con j-q-x y su orden de aparici√≥n", shortTitle: "J-Q-X",
        options: ["xq q x x q x x j x j x j j jj q j","xq x q q q x x j x j x j j jj j j","xq x q q q j j j x j x j j jj x x","xq x q q q x x j x j x j j jj j q"], correctIndex:3 }
    ];

    // State
    let currentQuestionIndex = 0;
    let questionAttempts = {};
    let correctAnswers = 0;
    let firstTryCorrectCount = 0;
    let firstTryCorrectByQuestion = {};
    let answered = false;
    let selectedAnswer = null;
    let shuffledOptions = [];
    let correctAnswerIndex = 0;
    let audioFiles = {};
    let audioFileNames = {};
    let isAdminMode = false;
    const RESULTS_KEY = 'juego_results';

    // Helpers
    function audioKeyData(i){ return `juego_audio_data_q${i}`; }
    function audioKeyName(i){ return `juego_audio_name_q${i}`; }
    function normalizeInput(s){ if(!s) return ''; return s.replace(/[\u200B-\u200D\uFEFF]/g,'').trim().normalize('NFC'); }
    function shuffleArray(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }

    // Persistence
    function getStoredResults(){ try { const raw = localStorage.getItem(RESULTS_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
    function storeResultLocal(record){ try { const arr = getStoredResults(); arr.push(record); localStorage.setItem(RESULTS_KEY, JSON.stringify(arr)); } catch(e){ console.warn(e); } }
    async function recordResult(record){ const user_name = localStorage.getItem('juego_user_name')||''; const user_group = localStorage.getItem('juego_user_group')||''; const question = QUESTIONS.find(q=>q.id===record.question_id); const rec = Object.assign({}, record, { user_name, user_group, question_title: question ? question.shortTitle : record.question_id }); try{ await window.dataSdk?.create?.(rec).catch(()=>{}); }catch(e){} storeResultLocal(rec); }

    function shuffleOptions(question){
      const opts = [...question.options];
      const correct = opts[question.correctIndex];
      shuffleArray(opts);
      correctAnswerIndex = opts.indexOf(correct);
      shuffledOptions = opts;
      return { options: shuffledOptions, correctIndex: correctAnswerIndex };
    }

    // Minimal audio persistence loader (we assume uploads happened earlier)
    function loadSavedAudios(){
      for(let i=0;i<QUESTIONS.length;i++){
        const data = localStorage.getItem(audioKeyData(i));
        const name = localStorage.getItem(audioKeyName(i));
        if(data && name){
          try { const audioEl = document.createElement('audio'); audioEl.src = data; audioEl.preload='auto'; audioFiles[i]=audioEl; audioFileNames[i]=name; } catch(e){ console.warn(e); }
        }
      }
    }

    // Render question
    function renderQuestion(reshuffle=true){
      const content = document.getElementById('gameContent');
      const q = QUESTIONS[currentQuestionIndex];
      if(!questionAttempts[q.id]) questionAttempts[q.id]=0;
      if(reshuffle || shuffledOptions.length===0) shuffleOptions(q);
      document.getElementById('progressFill').style.width = ((currentQuestionIndex)/QUESTIONS.length*100)+'%';
      const hasAudio = !!audioFiles[currentQuestionIndex];
      const audioFileName = audioFileNames[currentQuestionIndex]||'';
      const audioSection = hasAudio && audioFileName ? `<div style="font-size:12px;color:#48bb78">‚úÖ Audio cargado: ${audioFileName}</div>` : `<div style="font-size:13px;color:#4a5568">No hay audio disponible.</div>`;
      content.innerHTML = `
        <div class="question-card" role="region" aria-label="Pregunta ${currentQuestionIndex+1}">
          <div class="question-title">${q.title}</div>
          <div class="audio-player">${audioSection}<div style="margin-top:8px"><button class="play-button" id="playButton" onclick="playAudio()" ${hasAudio ? '' : 'disabled'}>‚ñ∂</button></div></div>
          <div class="options-grid" id="optionsGrid"></div>
          <div id="feedback" aria-live="polite"></div>
          <div id="pandaCelebration" style="min-height:160px; position:relative;"></div>
          <div style="margin-top:8px;text-align:center;font-size:12px;color:#718096">Intentos en esta pregunta: <span id="attemptsIndicator">${questionAttempts[q.id]}</span></div>
          <div style="display:flex;gap:10px;margin-top:12px;"><button class="small-btn" id="nextButton" style="display:none" onclick="nextQuestion()">${currentQuestionIndex < QUESTIONS.length-1 ? 'Siguiente Pregunta' : 'Ver Resultados'}</button></div>
        </div>
      `;
      renderOptionsGrid();
      answered=false; selectedAnswer=null;
    }

    function renderOptionsGrid(){
      const g = document.getElementById('optionsGrid'); if(!g) return;
      g.innerHTML = shuffledOptions.map((o,i)=>`<button class="option-button" id="option${i}" onclick="selectAnswer(${i})">${o}</button>`).join('');
      document.querySelectorAll('.option-button').forEach(b=>b.disabled=false);
    }

    window.playAudio = function(){
      const btn = document.getElementById('playButton');
      const a = audioFiles[currentQuestionIndex];
      if(!a){ console.log('No audio for this question'); return; }
      if(a.paused){ if(btn){btn.textContent='‚è∏';} a.play().catch(e=>{ console.error(e); if(btn) btn.textContent='‚ñ∂'; }); a.onended = ()=>{ if(btn) btn.textContent='‚ñ∂'; };
      } else { a.pause(); if(btn) btn.textContent='‚ñ∂'; }
    };

    window.selectAnswer = async function(index){
      if(answered && selectedAnswer===index) return;
      const q = QUESTIONS[currentQuestionIndex];
      questionAttempts[q.id] = (questionAttempts[q.id]||0)+1;
      const attemptsEl = document.getElementById('attemptsIndicator'); if(attemptsEl) attemptsEl.textContent = questionAttempts[q.id];
      const isCorrect = index === correctAnswerIndex;
      selectedAnswer = index;
      document.querySelectorAll('.option-button').forEach(b=>b.disabled=true);
      const btn = document.getElementById(`option${index}`); if(btn) btn.classList.add(isCorrect ? 'correct' : 'incorrect');
      const feedback = document.getElementById('feedback');

      if(isCorrect){
        correctAnswers++;
        const firstTry = questionAttempts[q.id] === 1;
        if(firstTry && !firstTryCorrectByQuestion[q.id]){ firstTryCorrectCount++; firstTryCorrectByQuestion[q.id] = true; }
        answered = true;
        if(feedback) feedback.className='feedback success';
        showPandaCelebration();
        const nextBtn = document.getElementById('nextButton'); if(nextBtn) nextBtn.style.display='inline-block';
        await recordResult({ question_id: q.id, attempts: questionAttempts[q.id], correct: true, skipped:false, first_try: firstTry, timestamp: (new Date()).toISOString(), game_session: gameSession });
      } else {
        if(feedback) { feedback.className='feedback error'; feedback.textContent = 'Vuelve a intentarlo'; }
        setTimeout(()=> {
          if(feedback) feedback.textContent = '';
          if(btn) btn.classList.remove('incorrect');
          shuffleOptions(q);
          renderOptionsGrid();
        }, 900);
      }
    };

    function showPandaCelebration(){
      const container = document.getElementById('pandaCelebration');
      if(!container) return;
      container.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'panda-center';
      wrap.innerHTML = `<div class="panda-emoji">üêº</div><div class="panda-text">Â§™Ê£í‰∫ÜÔºÅ</div>`;
      container.appendChild(wrap);
      createConfettiBurst(container);
    }
    function createConfettiBurst(container){
      const colors = ['#667eea','#764ba2','#48bb78','#f6e05e','#fc8181'];
      for(let i=0;i<18;i++){
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = (5 + Math.random()*90) + '%';
        c.style.top = (5 + Math.random()*20) + 'px';
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        c.style.animationDuration = (1.2 + Math.random()*1.4) + 's';
        container.appendChild(c);
        setTimeout(()=>{ if(c.parentNode) c.parentNode.removeChild(c); }, 3000);
      }
    }

    function nextQuestion(){ currentQuestionIndex++; shuffledOptions=[]; if(currentQuestionIndex < QUESTIONS.length) renderQuestion(); else showResults(); }

    function showResults(){
      const content = document.getElementById('gameContent');
      const totalAttempts = Object.values(questionAttempts).reduce((a,b)=>a+b,0);
      document.getElementById('progressFill').style.width = '100%';
      const perQuestionLines = QUESTIONS.map((q, idx) => {
        const attempts = questionAttempts[q.id] || 0;
        return `<div style="display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#fff;margin-bottom:8px;"><div><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong></div><div style="font-weight:700;color:#334155">${attempts}</div></div>`;
      }).join('');
      content.innerHTML = `
        <div style="text-align:center;padding:26px;">
          <div style="font-size:64px">üêºüéâ</div>
          <h2>¬°Juego completado!</h2>
          <div style="margin-top:18px;text-align:left;max-width:720px;margin-left:auto;margin-right:auto">
            <div style="display:flex;justify-content:space-between;padding:14px;border-radius:12px;background:#fff;margin-bottom:12px">
              <div>
                <div style="font-size:13px;color:#94a3b8">Respuestas acertadas</div>
                <div style="font-size:28px;font-weight:800;color:#667eea">${firstTryCorrectCount}/${QUESTIONS.length}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:#94a3b8">Intentos totales</div>
                <div style="font-size:22px;font-weight:700;color:#2d3748">${totalAttempts}</div>
              </div>
            </div>
            <div style="font-size:15px;font-weight:700;margin-bottom:8px">Detalle intentos:</div>
            ${perQuestionLines}
          </div>
          <div style="margin-top:18px"><button class="small-btn" onclick="restartGame()" style="padding:10px 16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px">Jugar de nuevo</button></div>
        </div>
      `;
      const sessionSummary = { game_session: gameSession, date: (new Date()).toISOString(), correctAnswers, firstTryCorrectCount, totalQuestions: QUESTIONS.length, attemptsByQuestion: questionAttempts, user_name: localStorage.getItem('juego_user_name')||'', user_group: localStorage.getItem('juego_user_group')||'' };
      storeResultLocal({ session: sessionSummary });
    }

    function restartGame(){
      currentQuestionIndex = 0;
      questionAttempts = {};
      correctAnswers = 0;
      firstTryCorrectCount = 0;
      firstTryCorrectByQuestion = {};
      answered = false;
      selectedAnswer = null;
      shuffledOptions = [];
      renderQuestion();
    }

    // Admin aggregated view (simplified)
    function buildAdminAggregatedView(){
      const rows = getStoredResults();
      const panel = document.getElementById('adminPanel');
      if(!rows || rows.length === 0){ panel.innerHTML = '<div>No hay resultados todav√≠a.</div>'; return; }
      // Extract session entries
      const sessionRows = rows.filter(r => r && r.session).map(r => r.session).slice().reverse();
      // If none, synthesize by grouping records by game_session
      const responseRecords = rows.filter(r => r && !r.session);
      const synthesized = {};
      responseRecords.forEach(r => {
        const sid = r.game_session || ('gen-'+(r.user_name||'u')+'-'+(r.timestamp||''));
        if(!synthesized[sid]) synthesized[sid] = { game_session: sid, date: r.timestamp||'', user_name: r.user_name||'', user_group: r.user_group||'', attemptsByQuestion: {}, correctAnswers:0, firstTryCorrectCount:0 };
        synthesized[sid].attemptsByQuestion[r.question_id] = Math.max(synthesized[sid].attemptsByQuestion[r.question_id]||0, r.attempts||0);
        if(r.correct) synthesized[sid].correctAnswers++;
        if(r.first_try) synthesized[sid].firstTryCorrectCount++;
      });
      const synthesizedList = Object.values(synthesized).reverse();
      const allSessions = sessionRows.length ? sessionRows.concat(synthesizedList) : synthesizedList;

      let html = `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px"><button class="small-btn" id="exportAllCsv">Exportar CSV</button><button class="small-btn" id="clearResultsBtn">Borrar resultados locales</button></div>`;
      html += `<div id="adminStats" style="margin-bottom:12px"></div>`;
      html += `<div>`;
      allSessions.forEach(s => {
        const dateStr = s.date ? (new Date(s.date)).toLocaleString() : '-';
        const user = s.user_name || 'An√≥nimo';
        const group = s.user_group ? ' ¬∑ ' + s.user_group : '';
        const totalCorrect = typeof s.correctAnswers === 'number' ? s.correctAnswers : (s.firstTryCorrectCount||0);
        const attemptsByQ = s.attemptsByQuestion || {};
        const detailHtml = QUESTIONS.map((q, idx) => `<div style="font-size:13px;color:#475569;margin-top:6px"><strong>Pregunta ${idx+1} (${q.shortTitle}):</strong> ${attemptsByQ[q.id] || '-'}</div>`).join('');
        html += `<div style="border-radius:10px;padding:12px;background:#fff;margin-bottom:8px;box-shadow:0 6px 18px rgba(12,20,40,0.04);display:flex;justify-content:space-between"><div><div style="font-weight:700">${user}${group}</div><div style="font-size:13px;color:#64748b;margin-top:4px">Fecha: ${dateStr}</div>${detailHtml}</div><div style="text-align:right"><div style="font-size:13px;color:#94a3b8">Total aciertos</div><div style="font-weight:800;font-size:20px;color:#334155;margin-top:6px">${totalCorrect}/${QUESTIONS.length}</div></div></div>`;
      });
      html += `</div>`;
      panel.innerHTML = html;
      document.getElementById('exportAllCsv').addEventListener('click', ()=> exportCsv(getStoredResults(), 'resultados_juego_all.csv'));
      document.getElementById('clearResultsBtn').addEventListener('click', ()=> { if(confirm('¬øBorrar todos los resultados guardados localmente?')){ localStorage.removeItem(RESULTS_KEY); buildAdminAggregatedView(); } });
      // small stats
      renderAdminStats(getStoredResults(), allSessions);
    }

    function renderAdminStats(allRows, sessions){
      const statsEl = document.getElementById('adminStats');
      if(!statsEl) return;
      const responseRecords = allRows.filter(r => r && !r.session);
      const failCounts = {};
      const totalPerQ = {};
      responseRecords.forEach(r => {
        if(!r.question_id) return;
        totalPerQ[r.question_id] = (totalPerQ[r.question_id]||0)+1;
        if(!r.correct) failCounts[r.question_id] = (failCounts[r.question_id]||0)+1;
      });
      let worstQ = 'N/A', worstFails=0, worstPct='-';
      Object.keys(failCounts).forEach(qid => {
        if(failCounts[qid] > worstFails){ worstFails = failCounts[qid]; worstQ = (QUESTIONS.find(q=>q.id===qid)?.shortTitle||qid); worstPct = ((failCounts[qid]/Math.max(1,totalPerQ[qid]))*100).toFixed(1)+'%'; }
      });
      const sessionRows = allRows.filter(r=>r && r.session).map(r=>r.session);
      const totalSessions = sessionRows.length || sessions.length;
      const users = new Set(); allRows.forEach(r=>{ if(r.user_name) users.add(r.user_name); if(r.session && r.session.user_name) users.add(r.session.user_name); });
      const uniqueUsers = users.size;
      const avg = uniqueUsers ? (totalSessions/uniqueUsers).toFixed(2) : '0.00';
      statsEl.innerHTML = `<div style="display:flex;gap:12px;flex-wrap:wrap"><div style="padding:10px;background:#fff;border-radius:8px">Sesiones: <strong>${totalSessions}</strong></div><div style="padding:10px;background:#fff;border-radius:8px">Usuarios √∫nicos: <strong>${uniqueUsers}</strong></div><div style="padding:10px;background:#fff;border-radius:8px">Media partidas/usuario: <strong>${avg}</strong></div><div style="padding:10px;background:#fff;border-radius:8px">Pregunta m√©s fallada: <strong>${worstQ}</strong> (${worstFails}) ${worstPct}</div></div>`;
    }

    function exportCsv(data, filename='resultados.csv'){
      if(!data || !data.length){ alert('No hay datos para exportar'); return; }
      const rows = [['user_name','user_group','type','question','attempts','correct','first_try','timestamp','game_session']];
      data.forEach(r => {
        if(r.session) rows.push([r.session.user_name||'', r.session.user_group||'', 'session_summary','', '', '', '', r.session.date||'', r.session.game_session||'']);
        else rows.push([r.user_name||'', r.user_group||'', 'respuesta', r.question_title||r.question_id||'', r.attempts||'', r.correct? '1':'0', r.first_try? '1':'0', r.timestamp||'', r.game_session||'']);
      });
      const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // UI: password overlay
    const pwOverlay = document.getElementById('passwordOverlay');
    const pwInput = document.getElementById('passwordInput');
    const pwBtn = document.getElementById('passwordBtn');
    const pwError = document.getElementById('passwordError');
    const showPassword = document.getElementById('showPassword');
    const userNameInput = document.getElementById('userName');
    const userGroupInput = document.getElementById('userGroup');
    const adminControls = document.getElementById('adminControls');
    const adminPanel = document.getElementById('adminPanel');
    const showAdminResultsBtn = document.getElementById('showAdminResultsBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const downloadResultsBtn = document.getElementById('downloadResultsBtn');
    const exportAudiosBtn = document.getElementById('exportAudiosBtn');

    showPassword.addEventListener('change', ()=> { pwInput.type = showPassword.checked ? 'text' : 'password'; });

    function prefillUserInfo(){ const n=localStorage.getItem('juego_user_name')||''; const g=localStorage.getItem('juego_user_group')||''; if(n) userNameInput.value=n; if(g) userGroupInput.value=g; }

    function showPasswordOverlay(){ try{ prefillUserInfo(); pwOverlay.style.display = 'flex'; userNameInput.focus(); }catch(e){ console.error('showPasswordOverlay error', e); } }

    function startGame(admin=false){
      isAdminMode = admin;
      if(isAdminMode){ adminControls.style.visibility='visible'; adminControls.setAttribute('aria-hidden','false'); } else { adminControls.style.visibility='hidden'; adminControls.setAttribute('aria-hidden','true'); }
      // attach admin handlers (safe)
      if(showAdminResultsBtn) showAdminResultsBtn.onclick = ()=> { if(adminPanel.style.display==='block'){ adminPanel.style.display='none'; } else { buildAdminAggregatedView(); adminPanel.style.display='block'; } };
      if(downloadCsvBtn) downloadCsvBtn.onclick = ()=> exportCsv(getStoredResults(), 'resultados_juego_all.csv');
      if(downloadResultsBtn) downloadResultsBtn.onclick = ()=> { const d=getStoredResults(); alert(`Registros locales: ${d.length}`); };
      if(exportAudiosBtn) exportAudiosBtn.onclick = ()=> { const items=[]; for(let i=0;i<QUESTIONS.length;i++){ const name = localStorage.getItem(audioKeyName(i)); const data = localStorage.getItem(audioKeyData(i)); items.push({index:i,name:name||'(no cargado)',hasData:!!data}); } alert('Estado audios: ' + items.map(it=>`Q${it.index+1}: ${it.name}${it.hasData?' (guardado)':''}`).join(' | ')); };
      const name = normalizeInput(userNameInput.value); const group = normalizeInput(userGroupInput.value);
      if(name) localStorage.setItem('juego_user_name', name); if(group) localStorage.setItem('juego_user_group', group);
      pwOverlay.style.display = 'none';
      loadSavedAudios();
      renderQuestion();
    }

    pwBtn.addEventListener('click', ()=>{
      try{
        const raw = pwInput.value || '';
        const val = normalizeInput(raw);
        const name = normalizeInput(userNameInput.value);
        const group = normalizeInput(userGroupInput.value);
        if(!name || !group){ pwError.textContent='Por favor, introduce Nombre usuario y Grupo'; pwError.style.display='block'; setTimeout(()=>pwError.style.display='none',3000); return; }
        if(name.length>30){ pwError.textContent='El nombre no puede tener m√°s de 30 caracteres'; pwError.style.display='block'; setTimeout(()=>pwError.style.display='none',3000); return; }
        if(val === ADMIN_PASSWORD) startGame(true);
        else if(val === STUDENT_PASSWORD) startGame(false);
        else { pwError.textContent='Contrase√±a incorrecta o campos incompletos'; pwError.style.display='block'; setTimeout(()=>pwError.style.display='none',2500); return; }
      }catch(e){ console.error('pwBtn click error', e); }
    });

    // ensure overlay shows after DOM ready and catch errors globally
    window.addEventListener('DOMContentLoaded', ()=> {
      try{
        console.log('DOM cargado ‚Äî mostrant overlay de password...');
        showPasswordOverlay();
        // small safety: expose debugging helpers
        window.__juego = { audioFiles, audioFileNames, getStoredResults };
      }catch(e){
        console.error('Error en DOMContentLoaded handler', e);
        alert('Ha ocurrido un error al inicializar el juego. Consulta la consola del navegador para m√°s detalles.');
      }
    });

    // global error catcher to help debugging if algo se rompe
    window.addEventListener('error', function(ev){
      console.error('Unhandled error:', ev.error || ev.message || ev);
      // show a tiny banner so you see algo va mal (opcional)
      try{
        const el = document.getElementById('gameContent');
        if(el && !document.getElementById('debugErrorBanner')){
          const b = document.createElement('div'); b.id='debugErrorBanner'; b.style.background='#fee2e2'; b.style.color='#7f1d1d'; b.style.padding='8px'; b.style.borderRadius='6px'; b.style.margin='10px'; b.textContent = 'Error en la aplicaci√≥n ‚Äî mira la consola (F12) para m√°s detalles.'; el.prepend(b);
        }
      }catch(e){}
    });

    // expose some functions useful for debugging
    window.__debug = { renderQuestion, buildAdminAggregatedView, showPasswordOverlay, getStoredResults };
  })();
  </script>
</body>
</html>
